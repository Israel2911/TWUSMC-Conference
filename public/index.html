<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TWU-SMC 11th Annual Leadership Conference</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<style>
    /* --- CORE STYLES --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); font-family: 'Nunito', sans-serif; color: #1a365d; overflow-x: hidden; line-height: 1.6; }
    
    .header { display: flex; align-items: center; justify-content: space-between; padding: 15px 40px; background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 2px 20px rgba(0,0,0,0.05); }
    .logo { font-size: 1.5rem; font-weight: 900; color: #167690; }
    .nav { display: flex; gap: 20px; align-items: center; }
    .nav a { text-decoration: none; color: #167690; font-weight: 700; transition: color 0.2s; }
    .nav a:hover { color: #128fa7; }
    .viewer-count { display: none; background: #ff0000; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; align-items: center; gap: 8px; animation: pulse-red 2s infinite; }
    
    /* --- HERO & LIVE --- */
    .hero { position: relative; min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 80px 20px; transition: all 0.5s ease; overflow: hidden; }
    .hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.6); transition: filter 0.5s ease; }
    .neural-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.2) 0%, transparent 60%); opacity: 0; animation: neural-fire 4s infinite ease-in-out; pointer-events: none; }
    @keyframes neural-fire { 0%, 100% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
    .hero-content-standard { position: relative; z-index: 5; max-width: 1200px; width: 100%; transition: opacity 0.5s ease; }
    .hero-content-live { position: relative; z-index: 10; width: 100%; max-width: 1400px; display: none; margin-top: 20px; }
    .hero h1 { font-size: 4rem; font-weight: 900; color: #167690; margin:0; }
    .hero h2 { font-size: 2rem; color: white; margin: 10px 0 30px 0; }

    /* --- FIXED SECTION START --- */
    .live-grid { 
      display: grid; 
      grid-template-columns: 2.5fr 1fr; 
      gap: 30px; 
      height: 70vh; 
      min-height: 500px; 
    }

    .video-wrapper { 
      background: black; 
      border-radius: 20px; 
      overflow: hidden; 
      border: 2px solid #333; 
      position: relative; 
      height: 100%; 
      width: 100%;
    }
    .video-wrapper.killed iframe { display: none !important; }
    .live-badge { position: absolute; top: 20px; left: 20px; background: #ff0000; color: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; z-index: 10; }

    .video-crop { width: 100%; height: 100%; display: block; }
    .video-crop iframe { width: 100%; height: 100%; border: none; display: block; }

    /* --- "THE HUMAN SPACE" (Chat System) --- */
    .human-space-container { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(15px); 
      border-radius: 20px; 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
      border: 1px solid rgba(255,255,255,0.3); 
      overflow: hidden; 
      position: relative; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
    }
    
    .human-space-header { background: linear-gradient(135deg, #167690, #0f5c70); color: white; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .hs-title-row { display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 1.1rem; }
    .tab-row { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 3px; }
    .hs-tab { flex: 1; background: transparent; border: none; color: rgba(255,255,255,0.7); padding: 8px; font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.2s; font-size: 0.9rem; }
    .hs-tab.active { background: white; color: #167690; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .hs-tab:hover:not(.active) { color: white; background: rgba(255,255,255,0.1); }
    
    .human-space-messages { 
      flex: 1; 
      padding: 20px; 
      overflow-y: auto; 
      display: none; 
      flex-direction: column; 
      gap: 12px; 
      font-size: 0.95rem; 
      background: #f0f4f8; 
      min-height: 0; 
    }

    .human-space-messages.active { display: flex; }
    .human-space-input { padding: 15px; background: white; border-top: 1px solid #eee; }
    .login-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
    .coi-note { font-size: 0.75rem; opacity: 0.6; margin-top: 30px; font-style: italic; border-top: 1px solid #eee; padding-top: 10px; max-width: 80%; }
    .msg { padding: 10px 15px; border-radius: 12px; background: white; align-self: flex-start; max-width: 90%; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-bottom-left-radius: 2px; position: relative; margin-bottom: 5px; }
    .msg.me { background: #167690; color: white; align-self: flex-end; border-bottom-left-radius: 12px; border-bottom-right-radius: 2px; }
    .msg.bot { background: #e6fffa; border-left: 4px solid #38b2ac; align-self: center; max-width: 95%; font-style: italic; color: #234e52; }
    .msg-meta { font-size: 0.7rem; opacity: 0.6; margin-bottom: 4px; display: block; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* --- QA STYLES --- */
    .qa-thread { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .qa-question { font-weight: bold; color: #2d3748; margin-bottom: 8px; font-size: 1rem; display: block; }
    .qa-replies { margin-top: 10px; padding-left: 15px; border-left: 3px solid #e2e8f0; font-size: 0.9rem; display: flex; flex-direction: column; gap: 8px; }
    
    .qa-reply-item { background: #f8f9fa; padding: 10px; margin-top: 5px; border-radius: 8px; border-left: 3px solid #ccc; font-size: 0.95rem; }
    .qa-reply-item span[onclick] { display: inline-block; margin-right: 5px; font-size: 0.8rem; color: #555; background: rgba(0,0,0,0.03); padding: 3px 8px; border-radius: 12px; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; }
    .qa-reply-item span[onclick]:hover { background: rgba(0,0,0,0.08); transform: scale(1.05); }
    .qa-reply-item span[onclick][style*="opacity:1"] { border-color: #167690 !important; background: rgba(22, 118, 144, 0.15) !important; color: #0e4b5b; font-weight: bold; }

    .reply-btn { font-size: 0.8rem; color: #167690; cursor: pointer; margin-top: 8px; display: inline-block; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    .reply-btn:hover { text-decoration: underline; }
    .msg-actions { display: flex; gap: 8px; margin-top: 5px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 5px; justify-content: flex-end; }
    .mod-btn { background: none; border: none; cursor: pointer; font-size: 1rem; opacity: 0.5; transition: 0.2s; display: flex; align-items: center; gap: 3px; color: inherit; }
    .mod-btn:hover { opacity: 1; transform: scale(1.1); color: #e53e3e; }
    .reaction-bar { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; }
    .reaction-btn { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 20px; padding: 6px 12px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; color: #2d3748; font-weight: 600; }
    .reaction-btn:hover { background: #167690; color: white; border-color: #167690; transform: translateY(-2px); }
    .input-row { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; outline: none; transition: 0.2s; font-family: inherit; }
    .chat-input:focus { border-color: #167690; }
    .send-btn { background: #167690; color: white; border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
    .send-btn:hover { background: #128fa7; }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; outline: none; }
    .login-input:focus { border-color: #167690; }
    .join-btn { background: linear-gradient(135deg, #167690, #0f5c70); color: white; padding: 15px 30px; border-radius: 30px; border: none; font-weight: 800; cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 10px; box-shadow: 0 5px 15px rgba(22, 118, 144, 0.3); transition: 0.2s; }
    .join-btn:hover { transform: scale(1.02); }
    .download-log { font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 6px; color: white; text-decoration: none; cursor: pointer; display: none; font-weight: normal; }
    .teams-link-header { color: rgba(255,255,255,0.8); font-size: 0.85rem; text-decoration: none; display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 15px; font-weight: 700; transition: 0.2s; }
    .teams-link-header:hover { background: rgba(255,255,255,0.2); color: white; }
    
    .teams-backup { background: linear-gradient(135deg, #1a0000, #000); padding: 40px; text-align: center; color: white; height: 100%; display: flex; flex-direction: column; justify-content: center; border-radius: 20px; }
    .teams-backup h2 { font-size: 2.8rem; margin-bottom: 15px; font-weight: 900; }
    .teams-backup a { background: linear-gradient(135deg, #464eb8, #3a3f9e); color: white; padding: 20px 40px; border-radius: 25px; font-weight: bold; font-size: 1.3rem; text-decoration: none; display: inline-flex; align-items: center; gap: 15px; box-shadow: 0 10px 30px rgba(70,78,184,0.4); transition: all 0.3s; margin: 20px 0; max-width: 400px; width: 100%; justify-content: center; }
    .teams-backup a:hover { transform: scale(1.05); box-shadow: 0 15px 40px rgba(70,78,184,0.6); }
    
    .global-connect-section { position: relative; z-index: 5; background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 50%, #000000 100%); padding: 80px 40px; display: flex; flex-wrap: wrap; justify-content: center; gap: 60px; max-width: 1400px; margin: 0 auto; }
    .globe-wrapper { width: 500px; height: 500px; position: relative; border-radius: 50%; background: radial-gradient(circle at 40% 40%, #1e2636 0%, #000000 90%); border: 4px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden; }
    .globe-wrapper::before { content: ""; position: absolute; inset: -10px; border-radius: 50%; pointer-events: none; mix-blend-mode: screen; background: radial-gradient(circle at 20% 15%, rgba(255, 230, 150, 0.45) 0, transparent 55%), radial-gradient(circle at 75% 25%, rgba(255,255,255,0.9) 0 2px, transparent 2px), radial-gradient(circle at 30% 70%, rgba(255,255,255,0.7) 0 1.5px, transparent 1.5px), radial-gradient(circle at 60% 85%, rgba(255,255,255,0.6) 0 1.8px, transparent 1.8px); animation: starTwinkle 6s ease-in-out infinite; }
    @keyframes starTwinkle { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
    #heroGlobeContainer { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; }
    .pause-btn { background: #167690; color: white; padding: 8px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
    .pause-btn:hover { background: #128fa7; transform: scale(1.05); }
    .times-wrapper { flex: 1; min-width: 350px; max-width: 600px; }
    .globe-times-stack { display: flex; flex-direction: column; gap: 12px; }
    .globe-time-item { background: white; padding: 15px 25px; border-radius: 16px; border: 1px solid #edf2f7; border-left: 6px solid #ddd; display: grid; grid-template-columns: 1.5fr 1.5fr 1fr; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: transform 0.2s; }
    .globe-time-item:hover { transform: translateX(5px); }
    .card-identity { display: flex; align-items: center; gap: 15px; }
    .globe-flag { font-size: 1.8rem; }
    .globe-name { font-weight: 800; color: #2d3748; font-size: 1.1rem; }
    .card-stats { display: flex; align-items: center; gap: 15px; color: #4a5568; font-size: 0.85rem; font-weight: 700; }
    .stat-pill { display: flex; align-items: center; gap: 6px; background: #e2e8f0; padding: 6px 14px; border-radius: 20px; color: #2d3748; }
    .material-icons-round { font-size: 16px; color: #4a5568; }
    .globe-time { font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.4rem; color: #ff6b35; text-align: right; }
    
    .section { padding: 80px 40px; max-width: 1200px; margin: 0 auto; text-align: center; }
    .section-header { font-size: 2.5rem; color: #167690; margin-bottom: 40px; font-weight:900; }
    .content-box { background: white; padding: 60px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.05); text-align: left; font-size: 1.1rem; }
    .synopsis-card { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.05); text-align: left; position: relative; overflow: hidden; transition: all 0.3s ease; }
    .synopsis-preview { font-size: 1.1rem; line-height: 1.8; }
    .synopsis-expanded { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
    .synopsis-expanded.open { max-height: 3000px; }
    .synopsis-expanded h3 { font-size: 1.35rem; color: #265057; margin-top: 25px; margin-bottom: 15px; }
    .synopsis-expanded blockquote { margin: 25px 0; padding: 20px; background: #f7f9ff; border-left: 6px solid #128fa7; font-size: 1.15rem; color: #265057; font-style: italic; }
    .expand-btn { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 25px; padding: 12px 30px; background: #167690; color: white; border: none; border-radius: 25px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; width: 100%; }
    .expand-btn:hover { background: #128fa7; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(22, 118, 144, 0.3); }
    .expand-btn .material-icons-round { transition: transform 0.3s ease; }
    .expand-btn.open .material-icons-round { transform: rotate(180deg); }
    .agenda-table { width: 100%; border-collapse: collapse; }
    .agenda-table tr { transition: background 0.2s; }
    .agenda-table tr:hover { background: #f7fafc; }
    .pdf-wrapper { width: 100%; height: 500px; border: none; border-radius: 15px; background: #eee; }
    .pdf-btn { display: inline-block; background: #167690; color: white; padding: 15px 30px; border-radius: 30px; text-decoration: none; font-weight: bold; margin-top: 20px; transition: 0.2s; }
    .pdf-btn:hover { background: #128fa7; transform: translateY(-2px); }
    
    /* --- ADMIN & TOGGLE BUTTONS --- */
    .admin-panel { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; gap: 10px; flex-direction: column; }
    .admin-btn { padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: all 0.3s; }
    .admin-btn:hover { transform: scale(1.05); }
    .btn-live { background: #333; color: white; } 
    .btn-kill { background: #ff0000; color: white; display: none; }
    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); color: #167690; } 100% { transform: scale(1); } }
    .pop { animation: pop 0.3s ease; }

    /* --- LAYOUT GRID FOR OVERVIEW (Desktop) --- */
    .synopsis-grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 60px;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* --- IMPORTANT FIX: BOOK CONTAINER WITH BLACK SPACE BACKGROUND --- */
    #bookContainer {
        width: 100%;
        height: 500px; 
        min-height: 400px;
        position: relative;
        /* "Black Space" Background Restored */
        background: radial-gradient(circle at 50% 50%, #2c3e50 0%, #000000 100%);
        border-radius: 30px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    /* --- MOBILE RESPONSIVE SUITE (Max-Width 768px) --- */
    @media screen and (max-width: 768px) {
    
        /* 1. GLOBAL LAYOUT & NAV */
        html, body { overflow-x: hidden; width: 100%; position: relative; }
        .header { flex-direction: column; padding: 15px; gap: 15px; }
        .nav { flex-wrap: wrap; justify-content: center; gap: 15px; }
        .logo { font-size: 1.3rem; text-align: center; }
    
        /* 2. HERO SECTION TEXT */
        .hero h1 { font-size: 2.2rem; line-height: 1.2; padding: 0 10px; }
        .hero h2 { font-size: 1.2rem; margin-bottom: 20px; }
        .hero { min-height: 60vh; padding: 40px 15px; }
    
        /* 3. CONFERENCE OVERVIEW GRID FIX */
        .synopsis-grid {
            display: flex !important;
            flex-direction: column-reverse !important; /* Book goes on TOP, Text on BOTTOM */
            gap: 20px !important;
        }

        .synopsis-card { 
            width: 100% !important;
            padding: 20px !important; 
            margin: 0 !important;
        }
        
        /* Force 3D Book Container Size */
        #bookContainer { 
            width: 100% !important; 
            height: 350px !important; 
            max-width: 350px !important; 
            margin: 0 auto !important;
            display: block !important;
            position: relative;
        }
    
        /* 4. LIVE STREAM & CHAT */
        .live-grid {
            display: flex !important;
            flex-direction: column;
            height: auto !important;
            gap: 15px;
        }
    
        .video-wrapper {
            width: 100% !important;
            height: auto !important;
            aspect-ratio: 16 / 9;
            min-height: 220px;
        }
    
        .human-space-container {
            width: 100% !important;
            height: 600px !important;
            border-left: none;
            border-top: 1px solid #ddd;
        }
    
        /* 5. GLOBAL COMMUNITY */
        .global-connect-section {
            flex-direction: column;
            padding: 40px 15px;
            gap: 30px;
        }
    
        .globe-wrapper {
            width: 280px !important;
            height: 280px !important;
            margin: 0 auto;
        }
    
        .times-wrapper {
            width: 100% !important;
            max-width: 100% !important;
        }
    
        .globe-times-stack {
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
    
        .globe-time-item {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            gap: 5px;
        }
        
        .card-identity { flex-direction: column; gap: 5px; }
        .globe-time { font-size: 1.1rem; text-align: center; width: 100%; margin-top: 5px; }
        .card-stats { display: flex; align-items: center; gap: 15px; }
    }
</style>


</head>
<body>

<!-- ADMIN CONTROLS -->
<div class="admin-panel" id="adminPanel">
  <button class="admin-btn btn-live" id="liveToggle">üî¥ GO LIVE</button>
  <button class="admin-btn btn-kill" id="killSwitch">‚ö†Ô∏è END STREAM</button>
</div>

<header class="header">
  <div class="logo">TWU-SMC 11th Annual Leadership Conference</div>
  <nav class="nav">
    <div class="viewer-count" id="viewerCount">
      <span class="material-icons-round">visibility</span>
      <span id="countNum">0</span> Watching
    </div>
    <a href="#">Home</a>
    <a href="#synopsis">About</a>
    <a href="#agenda">Agenda</a>
    <a href="#resources">Resources</a>
  </nav>
</header>


  <section class="hero">
  <img src="humanintelligence.png" alt="Background" class="hero-bg" id="heroBg">
  <div class="neural-overlay"></div>
  <div class="hero-content-standard" id="heroStandard">
    <h1>The Fifth Intelligence</h1>
    <h2>Integrating the Human Factor</h2>
  </div>
  

<div class="hero-content-live" id="heroLive" style="display:none;">
  <div class="live-grid">
    
    <!-- 1. VIDEO COLUMN -->
    <div class="video-wrapper" id="vidWrap">
      <div class="live-badge">üî¥ LIVE</div>
      <div class="video-crop">
        <iframe 
          id="feed" 
          src="https://www.youtube.com/embed/97vsV_lwXPo?autoplay=0&controls=1&mute=0&playsinline=1&modestbranding=1&rel=0" 
          width="100%" 
          height="100%" 
          title="TWU-SMC Leadership Conference Live Stream"
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          allowfullscreen>
        </iframe>
      </div>
    </div>

    <!-- 2. CHAT COLUMN -->
    <div class="human-space-container">
      <div class="human-space-header">
        <div class="hs-title-row">
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="material-icons-round">forum</span>
            The Human Space
          </div>
          <div style="display:flex; gap:10px;">
            <a href="https://teams.microsoft.com/meet/25727590322372?p=Toyeb2xMWy8NeEJiA2" target="_blank" class="teams-link-header" title="Join Teams Call">
              <span class="material-icons-round" style="font-size:16px;">videocam</span> Teams
            </a>
            <a id="downloadLogBtn" class="download-log">‚¨á LOG</a>
          </div>
        </div>
        <div class="tab-row">
          <button class="hs-tab active" onclick="switchTab('chat')">üí¨ Chat Lounge</button>
          <button class="hs-tab" onclick="switchTab('qa')">‚ùì Q&A Forum</button>
        </div>
      </div>
      
      <div class="login-overlay" id="chatLogin">
        <h3 style="font-size:1.5rem; color:#167690; margin-bottom:10px;">Enter the Human Space</h3>
        <p style="font-size:1rem; margin-bottom:30px; color:#666;">Secure, Proprietary, Connected.</p>
        <input type="text" id="chatName" class="login-input" placeholder="Your Name" maxlength="20">
        <select id="chatCountry" class="login-input">
          <option value="" disabled selected>Select Your Region</option>
          <option value="India">üáÆüá≥ India</option>
          <option value="Canada">üá®üá¶ Canada</option>
          <option value="Thailand">üáπüá≠ Thailand</option>
          <option value="USA">üá∫üá∏ USA</option>
          <option value="UK">üá¨üáß UK</option>
          <option value="Europe">üá™üá∫ Europe</option>
          <option value="Other">üåç Global</option>
        </select>
        <button class="join-btn" onclick="joinChat()">Join Conversation</button>
        <div class="coi-note">Inspired by the <strong>Community of Inquiry (CoI)</strong> framework.</div>
      </div>

      <div class="human-space-messages active" id="chatTab">
        <div style="text-align:center; opacity:0.6; margin-top:40px; padding:20px;">
          <span class="material-icons-round" style="font-size:3rem; color:#cbd5e0;">public</span>
          <br><br><strong>Global Lounge</strong><br>Say hello, share reactions, and connect.
        </div>
      </div>

      <div class="human-space-messages" id="qaTab">
        <div style="text-align:center; opacity:0.6; margin-top:40px; padding:20px;">
          <span class="material-icons-round" style="font-size:3rem; color:#cbd5e0;">psychology_alt</span>
          <br><br><strong>Q&A Forum</strong><br>Post deep questions here. Faculty will respond.
        </div>
      </div>

      <div class="human-space-input">
        <div class="reaction-bar" id="reactionBar">
          <button class="reaction-btn" onclick="sendReaction('üëã Hello Everyone!')">üëã Hello!</button>
          <button class="reaction-btn" onclick="sendReaction('üëè Insightful!')">üëè Insightful</button>
          <button class="reaction-btn" onclick="sendReaction('üí° Great Question')">üí° Great Question</button>
          <button class="reaction-btn" onclick="sendReaction('‚ù§Ô∏è Love this')">‚ù§Ô∏è Love this</button>
        </div>
        <div class="input-row">
          <input type="text" id="msgInput" class="chat-input" placeholder="Share your thoughts..." onkeypress="handleEnter(event)">
          <button class="send-btn" onclick="sendMessage()">
            <span class="material-icons-round">send</span>
          </button>
        </div>
      </div>
    </div>
    
  </div>
</div>




</section>

<section class="global-connect-section">
  <div class="globe-wrapper">
    <div id="heroGlobeContainer"></div> 
    <div style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%);">
      <button class="pause-btn" id="pauseBtn">‚è∏ Pause</button>
    </div>
  </div>
  <div class="times-wrapper">
    <h3 style="font-size: 2rem; color:#ffffff; margin-bottom:30px; font-weight:900;">üåç Global Community</h3>
    <div class="globe-times-stack" id="timeStack"></div>
  </div>
</section>

<section class="section" id="synopsis">
  <h2 class="section-header">Conference Overview</h2>
  <!-- CHANGED from inline style to class "synopsis-grid" -->
  <div class="synopsis-grid">
    <div class="synopsis-card">
      <div class="synopsis-preview">
        <p style="margin-bottom: 20px;">
          Join us as <strong>Dr. Laird</strong>, Vice President of Innovation, Global and Academic Partnerships at TWU, unveils concepts from his new book on <strong>"Fifth Intelligence."</strong>
        </p>
        <p style="margin-bottom: 20px;">
          Joined by industry experts, educators, and government leaders, engage in provocative panel discussions on AI's impact on consciousness, behavior, work, and institutions.
        </p>
        <p style="font-size: 1.05rem; color: #265057;">
          Transformative insights from global thought leaders united by a shared vision for responsible AI leadership.
        </p>
      </div>
      <div class="synopsis-expanded" id="synopsisExpanded">
        <h3 style="font-size: 1.5rem; color: #167690; margin-top: 30px; margin-bottom: 15px;">Integrating the Human Factor in the Age of AI</h3>
        <p style="font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; color: #265057;">
          <strong>How do we take back the human mind?</strong>
        </p>
        <p style="margin-bottom: 30px;">
          This conference explores how higher-order human thinking, critical consciousness, and emotional intelligence can steer AI development.
        </p>

        <!-- SUB-CARDS GRID -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #167690; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 1.1rem;">Emotional Intelligence & Perspective-Taking</h4>
            <p style="font-size: 0.95rem; color: #4a5568;">Understanding how AI impacts human empathy and our ability to see the world through others' eyes.</p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #48bb78; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 1.1rem;">Truth, Transparency, and Accountability</h4>
            <p style="font-size: 0.95rem; color: #4a5568;">Ensuring AI systems operate with verifiable truth and clear lines of responsibility for their outputs.</p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #ed8936; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 1.1rem;">Critical Thinking & Higher-Order Consciousness</h4>
            <p style="font-size: 0.95rem; color: #4a5568;">Cultivating the uniquely human cognitive skills that AI cannot replicate, preserving our intellectual autonomy.</p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #ecc94b; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 1.1rem;">Relationship-Centered AI</h4>
            <p style="font-size: 0.95rem; color: #4a5568;">Designing technology that enhances rather than replaces authentic human connection and social fabric.</p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #9f7aea; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 1.1rem;">Human Oversight & AI Quality</h4>
            <p style="font-size: 0.95rem; color: #4a5568;">Maintaining meaningful human control over automated systems to ensure quality, safety, and ethical alignment.</p>
          </div>

          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #f56565; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">
            <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 1.1rem;">Trustworthy AI for Global Good</h4>
            <p style="font-size: 0.95rem; color: #4a5568;">Building AI frameworks that promote global well-being, fairness, and sustainable progress for all nations.</p>
          </div>
        </div>

        <blockquote>
          <strong>Key Message:</strong> AI amplifies capabilities, but human sensitivity and ethical grounding must lead the way.
        </blockquote>
      </div>
      <button class="expand-btn" id="expandBtn">
        <span>Read More</span>
        <span class="material-icons-round">expand_more</span>
      </button>
    </div>

    <!-- BOOK CONTAINER -->
    <div style="width: 100%; display: flex; justify-content: center; align-items: center;">
      <div id="bookContainer"></div>
    </div>
  </div>
</section>

<section class="section" id="agenda">
  <h2 class="section-header">Agenda</h2>
  <div class="content-box" style="padding:0; overflow:hidden;">
    <table class="agenda-table" style="width:100%; border-collapse:collapse;">
      <tr style="background:#167690; color:white;"><th style="padding:15px;">Time (IST)</th><th style="padding:15px;">Session</th></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">10:00 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Welcome & Opening</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">10:15 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Conference Overview / Book Launch</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">10:30 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Keynote: Fifth Intelligence</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">11:15 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Workshop: Human-AI Integration</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">03:30 PM</td><td style="padding:15px; border-bottom:1px solid #eee;">Closing</td></tr>
    </table>
  </div>
</section>

<section class="section" id="resources">
  <h2 class="section-header">Resources</h2>
  <div class="content-box" style="text-align:center; padding: 40px 20px;">
    <h3>Conference Brochure</h3>
    <p style="margin-bottom:20px; opacity:0.8;">View, scroll, and download the full schedule below.</p>
    
    <div style="position: relative; width: 100%; height: 0; padding-bottom: 75%; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #ddd; background: #525659;">
      <object 
        data="GLOB%20SMC%20Leadership%20Conference%202025_Brochure_Final5.pdf#toolbar=1&view=FitH&navpanes=0" 
        type="application/pdf" 
        width="100%" 
        height="100%" 
        style="position: absolute; top: 0; left: 0; border: none;">
          <iframe 
            src="GLOB%20SMC%20Leadership%20Conference%202025_Brochure_Final5.pdf#toolbar=1&view=FitH" 
            width="100%" 
            height="100%" 
            style="border:none;">
          </iframe>
      </object>
    </div>

    <br>
    <a href="GLOB%20SMC%20Leadership%20Conference%202025_Brochure_Final5.pdf" download class="pdf-btn">
      <span class="material-icons-round" style="vertical-align:middle; margin-right:5px;">download</span> Download PDF
    </a>
  </div>
</section>

<script>
/* --- 1. SECURITY & SOCKET SETUP --- */
let s;
try { s = io(); } catch(e) {
  console.warn("OFFLINE MODE");
  s = { emit: (e,d)=>console.log(`Mock Emit: ${e}`,d), on: (e,c)=>console.log(`Mock Listen: ${e}`) };
}

// Send Timezone immediately
s.emit('r', Intl.DateTimeFormat().resolvedOptions().timeZone);

let myName = "";
let myCountry = "";
let currentTab = "chat"; 
let rawChatData = [];
let rawQaData = [];

// DOM Elements
const hS = document.getElementById('heroStandard'),
      hL = document.getElementById('heroLive'),
      hB = document.getElementById('heroBg'),
      vC = document.getElementById('viewerCount'),
      cN = document.getElementById('countNum'),
      kS = document.getElementById('killSwitch'),
      lT = document.getElementById('liveToggle'),
      vW = document.getElementById('vidWrap'),
      chatTab = document.getElementById('chatTab'),
      qaTab = document.getElementById('qaTab'),
      msgInput = document.getElementById('msgInput'),
      reactionBar = document.getElementById('reactionBar'),
      downloadBtn = document.getElementById('downloadLogBtn'),
      stackEl = document.getElementById('timeStack');

// --- INJECT CUSTOM POPUPS ---
const popupsHTML = `
<!-- PLEDGE MODAL -->
<div id="pledgeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:35px; border-radius:15px; max-width:550px; width:90%; text-align:center; color:#333; box-shadow:0 20px 50px rgba(0,0,0,0.5);">
    <div style="font-size:3rem; margin-bottom:10px;">‚òï</div>
    <h2 style="color:#167690; margin-bottom:15px; font-weight:800;">Welcome to Human Space</h2>
    <p style="font-size:1.1rem; line-height:1.6; margin-bottom:25px; color:#444;">
      We invite you to practice <strong>inclusive leadership</strong> in a space designed for connection.
    </p>
    <div style="background:#f1f9fc; border-left:5px solid #167690; padding:20px; text-align:left; margin-bottom:30px; border-radius:0 10px 10px 0;">
      <strong style="color:#0e4b5b; display:block; margin-bottom:10px; font-size:1.1rem;">‚ù§Ô∏è Our Community Heart:</strong>
      <ul style="margin:0; padding-left:20px; color:#555; line-height:1.8;">
        <li><strong>Scholarly yet Casual:</strong> Share research or just ask honest questions.</li>
        <li><strong>Collaboration over Debate:</strong> Build ideas up, don't tear them down.</li>
        <li><strong>Everyone is Welcome:</strong> Experts and students alike.</li>
      </ul>
      <br>
      <small style="color:#888;">üõ°Ô∏è <strong>Safety:</strong> You can Flag (‚öë) content. 3 Flags removes a post.</small>
    </div>
    <button onclick="acceptPledge()" style="background:linear-gradient(135deg, #167690, #0e4b5b); color:white; border:none; padding:15px 40px; font-size:1.2rem; border-radius:30px; cursor:pointer; font-weight:bold;">
      I Agree & Enter
    </button>
  </div>
</div>

<!-- REACTION PICKER -->
<div id="reactPicker" style="display:none; position:absolute; background:white; border-radius:30px; padding:5px 10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); z-index:1000; border:1px solid #eee;">
    <span onclick="pickReact('‚ù§Ô∏è')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">‚ù§Ô∏è</span>
    <span onclick="pickReact('üòÇ')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üòÇ</span>
    <span onclick="pickReact('üëç')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üëç</span>
    <span onclick="pickReact('üî•')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üî•</span>
    <span onclick="pickReact('ü§î')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">ü§î</span>
    <span onclick="pickReact('üéâ')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üéâ</span>
    <span onclick="pickReact('üôè')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üôè</span>
    <span onclick="closeReact()" style="cursor:pointer; font-size:1rem; margin-left:8px; color:#999;">‚úï</span>
</div>

<!-- Q&A REPLY OVERLAY -->
<div id="replyOverlay" style="display:none; position:absolute; bottom:0; left:0; width:100%; background:#f8f9fa; border-top:1px solid #ddd; padding:15px; z-index:1001; box-shadow:0 -5px 20px rgba(0,0,0,0.1);">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <strong style="color:#167690;">Reply to Question</strong>
        <span onclick="closeReply()" style="cursor:pointer; font-weight:bold; color:#666;">‚úï</span>
    </div>
    <input type="text" id="replyInput" placeholder="Type your answer..." style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px;">
    <button onclick="submitReply()" style="width:100%; background:#167690; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">Post Reply</button>
</div>
`;
document.body.insertAdjacentHTML('beforeend', popupsHTML);

// Chat Reaction Bar Logic
if(reactionBar) {
    reactionBar.style.display = 'flex';
    reactionBar.innerHTML = `
      <button onclick="sendReaction('üëè')">üëè</button>
      <button onclick="sendReaction('üî•')">üî•</button>
      <button onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
      <button onclick="sendReaction('Thinking...')">ü§î</button>
      <button onclick="sendReaction('Agreed!')">‚úÖ</button>
    `;
}

if(new URLSearchParams(window.location.search).get('m')==='a') localStorage.setItem('a','1');
if(document.getElementById('adminPanel')) document.getElementById('adminPanel').style.display='flex';

/* --- 2. SYNOPSIS READ MORE LOGIC --- */
const expandBtn = document.getElementById('expandBtn');
if(expandBtn) {
  expandBtn.addEventListener('click', function() {
    const content = document.getElementById('synopsisExpanded');
    content.classList.toggle('open');
    this.classList.toggle('open');
    const icon = this.querySelector('.material-icons-round');
    if(icon) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
    const span = this.querySelector('span');
    if(span) span.textContent = content.classList.contains('open') ? 'Read Less' : 'Read More';
  });
}

/* --- 3. LIVE STREAM LOGIC --- */
if(lT) lT.onclick = () => { s.emit('x'); };

// *** SECURE KILL SWITCH LOGIC ***
if(kS) kS.onclick = () => { 
    const pass = prompt("Enter Admin Password to Kill Stream:");
    if(pass) s.emit('k', pass); 
};

s.on('z', (state) => {
  const isLive = (typeof state === 'object') ? state.isLive : state;
  const isKilled = (typeof state === 'object') ? state.isKilled : false;
  toggleLiveUI(isLive);
  if (localStorage.getItem('a') === '1' && kS) {
    kS.style.display = 'block';
    if (isKilled) { kS.disabled = true; kS.innerHTML = '‚úÖ KILLED'; kS.style.opacity = '0.7'; }
    else { kS.disabled = false; kS.innerHTML = '‚ö†Ô∏è KILL STREAM'; kS.style.opacity = '1'; }
  } else if (kS) { kS.style.display = 'none'; }
  if(isKilled) killStreamUI();
});

s.on('d', () => { if(vW) vW.classList.add('killed'); });
s.on('t', (c) => { if(cN) cN.innerText = c; });

function toggleLiveUI(isLive) {
  if(hS) hS.style.display = isLive ? 'none' : 'block';
  if(hL) hL.style.display = isLive ? 'block' : 'none';
  if(hB) hB.style.filter = isLive ? 'brightness(0.2)' : 'brightness(0.6)';
  if(vC) vC.style.display = isLive ? 'flex' : 'none';
  if(lT) { lT.innerHTML = isLive ? 'üü¢ LIVE' : 'üî¥ GO LIVE'; lT.style.background = isLive ? '#00cc00' : '#333'; }
}

function killStreamUI() {
  if(hL) {
    hL.innerHTML = `
      <div class="teams-backup" style="background:linear-gradient(135deg,#1a0000,#000);padding:40px;text-align:center;color:white;height:100%;display:flex;flex-direction:column;justify-content:center;border-radius:20px;">
        <div style="font-size:5rem;margin-bottom:20px;animation:pulse-red 2s infinite;">üî¥</div>
        <h2 style="font-size:2.5rem;margin-bottom:15px;font-weight:900;">Stream Continues on Teams</h2>
        <p style="font-size:1.3rem;opacity:0.9;margin-bottom:30px;">Please join the secure session below</p>
        <a href="https://teams.microsoft.com/meet/25727590322372?p=Toyeb2xMWy8NeEJiA2" target="_blank"
           style="background:linear-gradient(135deg,#464eb8,#3a3f9e);color:white;padding:20px 40px;border-radius:25px;font-weight:bold;font-size:1.3rem;text-decoration:none;display:inline-flex;align-items:center;gap:15px;box-shadow:0 10px 30px rgba(70,78,184,0.4);margin:0 auto;max-width:400px;width:100%;justify-content:center;">
          üì± Join Teams Stream ‚Üí
        </a>
      </div>`;
  }
}

/* --- 4. TIME CARDS + WEATHER + USER STATS --- */
const countries=[{name:'India',flag:'üáÆüá≥',tz:'Asia/Kolkata',lat:22,lng:78,color:'#FF9933'},{name:'Canada',flag:'üá®üá¶',tz:'America/Vancouver',lat:56,lng:-106,color:'#ff0000'},{name:'Thailand',flag:'üáπüá≠',tz:'Asia/Bangkok',lat:13,lng:100,color:'#ffcc00'},{name:'Europe',flag:'üá™üá∫',tz:'Europe/Paris',lat:48,lng:2,color:'#0000FF'},{name:'UK',flag:'üá¨üáß',tz:'Europe/London',lat:53,lng:-0.1,color:'#191970'},{name:'USA',flag:'üá∫üá∏',tz:'America/New_York',lat:39,lng:-98,color:'#003366'},{name:'Singapore',flag:'üá∏üá¨',tz:'Asia/Singapore',lat:1.3,lng:103,color:'#EE2536'},{name:'Malaysia',flag:'üá≤üáæ',tz:'Asia/Kuala_Lumpur',lat:4,lng:102,color:'#FFD700'}];

// Weather Config
const weatherTypes = [
  { icon: 'wb_sunny', tempBase: 28, label: 'Sunny' },
  { icon: 'cloud', tempBase: 18, label: 'Cloudy' },
  { icon: 'water_drop', tempBase: 22, label: 'Rainy' },
  { icon: 'thunderstorm', tempBase: 24, label: 'Storm' },
  { icon: 'ac_unit', tempBase: -2, label: 'Snow' }
];

// Initial Render
if(stackEl && stackEl.innerHTML.trim()==="") {
  countries.forEach((c,i)=>{
    stackEl.innerHTML+=`
    <div class="globe-time-item" style="border-left-color:${c.color}">
      <div class="card-identity">
        <span class="globe-flag">${c.flag}</span>
        <span class="globe-name">${c.name}</span>
      </div>
      <div class="card-stats">
        <div class="stat-pill" title="Live Viewers">
          <!-- FIX: Changed from 'people' to 'visibility' -->
          <span class="material-icons-round">visibility</span>
          <span id="count-${i}">0</span>
        </div>
        <div class="stat-pill" title="Weather Condition">
          <span class="material-icons-round" id="w-icon-${i}">wb_sunny</span>
          <span id="weather-${i}" style="margin-left:5px; font-weight:700;">--¬∞C</span>
        </div>
      </div>
      <div class="globe-time" id="stack-time-${i}">--:--</div>
    </div>`;
  });
}

function updateStackTimes(){
  const n=new Date();
  countries.forEach((c,i)=>{
    try{
      const e=document.getElementById(`stack-time-${i}`);
      if(e) e.innerText=n.toLocaleTimeString('en-GB',{timeZone:c.tz,hour:'2-digit',minute:'2-digit'});
    }catch(e){}
  });
}

// SIMULATE DATA (Since we don't have real backend data for this demo)
function simulateLiveStats() {
  countries.forEach((c, i) => {
    // Random User Count (Active Simulation)
    const userCount = Math.floor(Math.random() * 40) + 5; 
    const elCount = document.getElementById(`count-${i}`);
    if(elCount) elCount.innerText = userCount;

    // Random Weather
    const w = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
    const tempVariance = Math.floor(Math.random() * 5);
    const finalTemp = w.tempBase + (Math.random() > 0.5 ? tempVariance : -tempVariance);
    
    const elWIcon = document.getElementById(`w-icon-${i}`);
    const elWText = document.getElementById(`weather-${i}`);
    
    if(elWIcon) elWIcon.innerText = w.icon;
    if(elWText) elWText.innerText = `${finalTemp}¬∞C`;
  });
}

// Init Intervals
setInterval(updateStackTimes, 1000);
updateStackTimes();
simulateLiveStats(); // Run once immediately
setInterval(simulateLiveStats, 60000); // Update stats every minute

/* --- 5. CHAT & MODERATION LOGIC --- */
function renderAllMessages() {
  if(chatTab) chatTab.innerHTML = '';
  if(qaTab) qaTab.innerHTML = '';
  
  rawChatData.forEach(msg => addMessage('chat', msg.user, msg.text, (msg.user === myName), msg.country, msg.id, msg.reactions, msg.flags));
  
  rawQaData.forEach(thread => {
    addQaThread(thread.user, thread.text, (thread.user === myName), thread.country, thread.id, thread.reactions, thread.flags);
    if(thread.replies) {
      thread.replies.forEach(rep => addQaReplyUI(thread.id, rep.id, rep.user, rep.text, rep.reactions));
    }
  });
}

s.on('initialLoad', (data) => {
  if (data.state) {
      toggleLiveUI(data.state.isLive);
      if(data.state.isKilled) killStreamUI();
  }
  if(data.chat) rawChatData = data.chat;
  if(data.qa) rawQaData = data.qa;
  renderAllMessages();
});

s.on('chatIncoming', (data) => { 
  rawChatData.push(data);
  addMessage('chat', data.user, data.text, (data.user===myName), data.country, data.id, data.reactions, data.flags); 
});

s.on('chatDeleted', (id) => {
  rawChatData = rawChatData.filter(m => m.id !== id);
  const el = document.getElementById(id); 
  if(el) el.remove();
});

s.on('qaDeleted', (id) => {
  rawQaData = rawQaData.filter(t => t.id !== id);
  const el = document.getElementById(id);
  if(el) el.remove();
});

s.on('qaIncoming', (data) => { 
  rawQaData.push(data);
  addQaThread(data.user, data.text, (data.user===myName), data.country, data.id, data.reactions, data.flags); 
});

// *** FIXED: Updated Listener for Reply Reactions ***
s.on('qaReplyIncoming', (data) => { 
  const thread = rawQaData.find(t => t.id === data.threadId);
  if(thread) {
     if(!thread.replies) thread.replies = [];
     // Store ID and Reactions locally
     thread.replies.push({ id: data.id, user: data.user, text: data.text, reactions: data.reactions });
  }
  addQaReplyUI(data.threadId, data.id, data.user, data.text, data.reactions); 
});

// *** NEW: Listener for Reply Reaction Updates ***
s.on('qaReplyReactionUpdate', (data) => {
   const { threadId, replyId, reactions } = data;
   const thread = rawQaData.find(t => t.id === threadId);
   if(thread && thread.replies) {
       const reply = thread.replies.find(r => r.id === replyId);
       if(reply) reply.reactions = reactions;
   }
   const container = document.getElementById(`reply-reacts-${replyId}`);
   if(container) container.innerHTML = renderReplyReactionButtons(threadId, replyId, reactions);
});

s.on('qaReactionUpdate', (data) => {
  const { threadId, reactions } = data;
  const thread = rawQaData.find(t => t.id === threadId);
  if(thread) thread.reactions = reactions;
  const reactBox = document.getElementById(`react-box-${threadId}`);
  if(reactBox) reactBox.innerHTML = renderReactionButtons(threadId, reactions);
});

s.on('chatReactionUpdate', (data) => {
    const { id, reactions } = data;
    const msg = rawChatData.find(m => m.id === id);
    if(msg) msg.reactions = reactions;
    const reactContainer = document.getElementById(`chat-reacts-${id}`);
    if(reactContainer) reactContainer.innerHTML = renderChatReactions(id, reactions);
});

function switchTab(name) {
  currentTab = name;
  document.querySelectorAll('.hs-tab').forEach(b => b.classList.remove('active'));
  if(event) event.target.classList.add('active');
  
  if(name === 'chat') {
    if(chatTab) chatTab.style.display = 'flex'; 
    if(qaTab) qaTab.style.display = 'none';
    if(reactionBar) reactionBar.style.display = 'flex';
    msgInput.placeholder = "Chat...";
  } else {
    if(qaTab) qaTab.style.display = 'flex'; 
    if(chatTab) chatTab.style.display = 'none';
    if(reactionBar) reactionBar.style.display = 'none';
    msgInput.placeholder = "Ask a Question...";
  }
}

function joinChat() {
  const n = document.getElementById('chatName').value.trim();
  if(!n) return alert("Name required");
  myName = n; myCountry = document.getElementById('chatCountry').value;
  document.getElementById('chatLogin').style.display = 'none';
  document.getElementById('pledgeModal').style.display = 'flex';
}

function acceptPledge() {
  document.getElementById('pledgeModal').style.display = 'none';
  renderAllMessages();
  s.emit('r', Intl.DateTimeFormat().resolvedOptions().timeZone);
}

function sendMessage() {
  const txt = msgInput.value.trim();
  if(!txt) return;

  if(!myName) {
      alert("Please Enter your Name & Join first!");
      document.getElementById('chatLogin').style.display = 'flex';
      return;
  }

  if(currentTab === 'chat') {
      s.emit('chatMsg', { user: myName, text: txt, country: myCountry });
  } else {
      s.emit('qaAsk', { user: myName, text: txt, country: myCountry });
  }
  msgInput.value = "";
}
function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

function sendReaction(txt) { 
    if(!myName) return; 
    s.emit('chatMsg', { user: myName, text: txt, country: myCountry }); 
}

function flagMsg(id, isMine) {
  if(isMine) {
     if(confirm("üóëÔ∏è Delete your message?")) s.emit('chatFlag', { id, user: myName });
  } else {
     if(confirm("‚öë Flag this as inappropriate?")) {
        const btn = document.getElementById(`flag-btn-${id}`);
        if(btn) { btn.style.color = 'red'; btn.style.opacity = '1'; btn.innerText = '‚öë'; }
        s.emit('chatFlag', { id, user: myName });
     }
  }
}

function flagQa(id, isMine) {
  if(isMine) {
     if(confirm("üóëÔ∏è Delete your thread?")) s.emit('qaFlag', { id, user: myName });
  } else {
     if(confirm("‚öë Flag this thread?")) {
         const btn = document.getElementById(`qa-flag-btn-${id}`);
         if(btn) { btn.style.color = 'red'; btn.style.opacity = '1'; }
         s.emit('qaFlag', { id, user: myName });
     }
  }
}

// --- POP-OVER REACTION PICKER ---
let targetMsgId = null;

function showChatReactPicker(id, event) {
    if(!myName) return alert("Join to react!");
    targetMsgId = id;
    const picker = document.getElementById('reactPicker');
    const rect = event.target.getBoundingClientRect();
    picker.style.top = (rect.top - 40) + 'px'; 
    picker.style.left = (rect.left - 50) + 'px';
    picker.style.display = 'block';
}

function pickReact(emoji) {
    if(targetMsgId) s.emit('chatReact', { id: targetMsgId, emoji, user: myName });
    closeReact();
}

function closeReact() {
    document.getElementById('reactPicker').style.display = 'none';
    targetMsgId = null;
}

// --- RENDER CHAT REACTIONS (NOW CLICKABLE) ---
function renderChatReactions(msgId, reactions) {
    if(!reactions) return '';
    let html = '';
    for(let emoji in reactions) {
        if(reactions[emoji].length > 0) {
            const iReacted = myName && reactions[emoji].includes(myName);
            const cursorStyle = myName ? 'pointer' : 'default';
            const activeStyle = iReacted ? 'border:1px solid #38bdf8; background:rgba(56,189,248,0.2);' : 'background:rgba(255,255,255,0.1);';
            html += `<span onclick="toggleChatReaction('${msgId}', '${emoji}')" 
                           style="padding:2px 5px; border-radius:10px; font-size:0.75rem; margin-right:3px; cursor:${cursorStyle}; ${activeStyle}"
                           title="${iReacted ? 'Click to remove' : 'Click to add'}">
                           ${emoji} ${reactions[emoji].length}
                     </span>`;
        }
    }
    return html;
}

function toggleChatReaction(msgId, emoji) {
    if(!myName) return alert("Please Join first!");
    s.emit('chatReact', { id: msgId, emoji, user: myName });
}

// --- IN-WINDOW QA REPLY ---
let targetQaId = null;

function openReplyUI(id) {
    if(!myName) return alert("Please Join the Chat first!");
    targetQaId = id;
    const overlay = document.getElementById('replyOverlay');
    if(qaTab) qaTab.appendChild(overlay); 
    overlay.style.display = 'block';
    document.getElementById('replyInput').focus();
}

function closeReply() {
    document.getElementById('replyOverlay').style.display = 'none';
    targetQaId = null;
}

function submitReply() {
    const txt = document.getElementById('replyInput').value.trim();
    if(txt && targetQaId) {
        s.emit('qaReply', { threadId: targetQaId, user: myName, text: txt });
        document.getElementById('replyInput').value = '';
        closeReply();
    }
}

function addMessage(target, user, text, isMe, country, id, reactions, flags) {
  if(!chatTab || (id && document.getElementById(id))) return; 
  const div = document.createElement('div');
  div.className = `msg ${isMe ? 'me' : ''}`;
  div.id = id; 
  
  const actionIcon = isMe ? 'üóëÔ∏è' : '‚öë';
  const hasFlagged = flags && flags.includes(myName);
  const flagColor = hasFlagged ? 'red' : 'inherit';
  const flagOpacity = hasFlagged || isMe ? '1' : '0.3'; 
  const flagPointer = hasFlagged ? 'default' : 'pointer';

  div.innerHTML = `
    <span class="msg-meta">${user}</span>
    ${text}
    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
        <div id="chat-reacts-${id}" style="display:flex;">${renderChatReactions(id, reactions)}</div>
        <div>
            <span onclick="showChatReactPicker('${id}', event)" style="cursor:pointer; opacity:0.5; font-size:0.8rem; margin-right:10px;" title="Add Reaction">‚ûï</span>
            <span id="flag-btn-${id}" 
                  onclick="${hasFlagged ? '' : `flagMsg('${id}', ${isMe})`}" 
                  style="cursor:${flagPointer}; opacity:${flagOpacity}; color:${flagColor}; font-size:0.85rem;" 
                  title="${isMe?'Delete':'Flag Inappropriate'}">${actionIcon}</span>
        </div>
    </div>
  `;
  chatTab.appendChild(div);
  chatTab.scrollTop = chatTab.scrollHeight;
}

function addQaThread(user, text, isMe, country, serverId, reactions, flags) {
  if(!qaTab) return; 
  if(serverId && document.getElementById(serverId)) return;
  const div = document.createElement('div');
  div.className = 'qa-thread'; 
  div.id = serverId;
  
  const isAi = (user === "ü§ñ Session Facilitator");
  const userDisplay = isAi ? `<span style="color:#ffcc00;font-weight:bold;">${user}</span>` : user;
  const bgStyle = isAi ? 'background:rgba(255,215,0,0.1); border-left:3px solid #ffcc00;' : '';
  const safeReactions = reactions || { 'üéì':[], 'üí°':[], 'ü§ù':[], '‚≠ê':[], 'üìú':[] };

  const actionIcon = isMe ? 'üóëÔ∏è' : '‚öë';
  const hasFlagged = flags && flags.includes(myName);
  const flagColor = hasFlagged ? 'red' : 'inherit';
  const flagOpacity = hasFlagged || isMe ? '1' : '0.3';
  const flagPointer = hasFlagged ? 'default' : 'pointer';

  div.style.cssText = bgStyle;
  div.innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <span class="qa-question">Q: ${text}</span>
      <span id="qa-flag-btn-${serverId}"
            onclick="${hasFlagged ? '' : `flagQa('${serverId}', ${isMe})`}" 
            style="cursor:${flagPointer}; opacity:${flagOpacity}; color:${flagColor};" 
            title="${isMe?'Delete':'Flag'}">${actionIcon}</span>
    </div>
    <div class="msg-meta">Asked by ${userDisplay} ‚Ä¢ ${country||'Global'}</div>
    <div class="qa-reactions" id="react-box-${serverId}" style="margin:5px 0; display:flex; gap:8px;">
      ${renderReactionButtons(serverId, safeReactions)}
    </div>
    <div class="qa-replies" id="replies-${serverId}"></div>
    <div style="margin-top:8px; padding-top:5px; border-top:1px solid #eee;">
      <span style="cursor:pointer; color:#167690; font-weight:800; font-size:0.8rem;" onclick="openReplyUI('${serverId}')">üí¨ REPLY</span>
    </div>
  `;
  qaTab.appendChild(div);
  qaTab.scrollTop = qaTab.scrollHeight;
}

const EMOJI_DEF = { 'üéì': 'Insightful', 'üí°': 'Great Idea', 'ü§ù': 'Agreement', '‚≠ê': 'Excellent', 'üìú': 'Source?' };

function renderReactionButtons(id, r) {
  const emojis = ['üéì', 'üí°', 'ü§ù', '‚≠ê', 'üìú'];
  return emojis.map(e => {
    const list = Array.isArray(r[e]) ? r[e] : []; 
    const count = list.length;
    const iVoted = myName && list.includes(myName);
    const activeStyle = iVoted ? 'border:1px solid #38bdf8; background:rgba(56,189,248,0.2);' : 'border:1px solid #333; background:rgba(255,255,255,0.05);';

    return `<span onclick="emitReact('${id}', '${e}')" 
           title="${EMOJI_DEF[e]}"
           style="cursor:pointer; padding:4px 8px; border-radius:15px; font-size:0.9rem; transition:all 0.2s; ${activeStyle}">
       ${e} ${count}
     </span>`;
  }).join('');
}

function emitReact(id, emoji) {
    if(!myName) return alert("Please Join first to react.");
    s.emit('qaReact', { threadId: id, emoji: emoji, user: myName });
}

// *** NEW: UPDATED addQaReplyUI to support SCHOLARLY Reactions ***
function addQaReplyUI(threadId, replyId, user, text, reactions) {
  const box = document.getElementById(`replies-${threadId}`);
  if(box) {
    if(document.getElementById(`reply-${replyId}`)) return;
    const div = document.createElement('div');
    div.className = 'qa-reply-item';
    div.id = `reply-${replyId}`;
    // *** UPDATED: Default to Scholarly Emojis ***
    const safeReacts = reactions || { 'üéì':[], 'üí°':[], 'ü§ù':[], '‚≠ê':[], 'üìú':[] };
    div.innerHTML = `
      <div><strong style="color:#167690">${user}:</strong> ${text}</div>
      <div id="reply-reacts-${replyId}" style="margin-top:5px; display:flex; gap:5px;">
        ${renderReplyReactionButtons(threadId, replyId, safeReacts)}
      </div>
    `;
    box.appendChild(div);
  }
}

// *** NEW: UPDATED to Render SCHOLARLY Emojis ***
function renderReplyReactionButtons(threadId, replyId, r) {
  const emojis = ['üéì', 'üí°', 'ü§ù', '‚≠ê', 'üìú'];
  return emojis.map(e => {
    const list = Array.isArray(r[e]) ? r[e] : [];
    const count = list.length;
    const iVoted = myName && list.includes(myName);
    const activeStyle = iVoted ? 'opacity:1; background:rgba(22,118,144,0.1);' : 'opacity:0.6;';
    const border = iVoted ? '1px solid #167690' : '1px solid transparent';
    return `<span onclick="emitReplyReact('${threadId}', '${replyId}', '${e}')" 
             style="cursor:pointer; font-size:0.75rem; padding:2px 6px; border-radius:10px; ${activeStyle} border:${border}; transition:0.2s;">
             ${e} ${count > 0 ? count : ''}
           </span>`;
  }).join('');
}

function emitReplyReact(threadId, replyId, emoji) {
   if(!myName) return alert("Join to react!");
   s.emit('qaReplyReact', { threadId, replyId, emoji, user: myName });
}

(function initGlobe() {
  const container = document.getElementById('heroGlobeContainer');
  if (!container) return;
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
  camera.position.set(0, 0, 4.8);
  const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(500, 500);
  container.appendChild(renderer.domElement);
  
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.8;
  
  scene.add(new THREE.AmbientLight(0xffffff, 0.8));
  const dLight = new THREE.DirectionalLight(0xffffff, 0.7); dLight.position.set(1, 1, 1); scene.add(dLight);
  
  const globeGroup = new THREE.Group(); scene.add(globeGroup); 
  globeGroup.rotation.y = 0; globeGroup.rotation.x = 0.2;
  
  new THREE.TextureLoader().load('https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Land_ocean_ice_2048.jpg/1024px-Land_ocean_ice_2048.jpg', (tex) => {
      const geo = new THREE.SphereGeometry(1, 64, 64);
      const mat = new THREE.MeshPhongMaterial({ map: tex, specular: 0x111111, shininess: 5 });
      globeGroup.add(new THREE.Mesh(geo, mat));
  });
  
  const flagSprites = [];
  function latLonToVec3(lat, lon, r) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);
    return new THREE.Vector3(-r * Math.sin(phi) * Math.cos(theta), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta));
  }
  
  function drawCanvas(ctx, country, timeStr) {
    ctx.clearRect(0, 0, 300, 150);
    ctx.fillStyle = 'rgba(10,16,30,0.85)'; ctx.beginPath();
    const r = 20, x = 10, y = 10, w = 280, h = 130;
    ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y); ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r); ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h); ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath(); ctx.fill(); ctx.lineWidth = 6; ctx.strokeStyle = country.color; ctx.stroke();
    ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 38px Arial';
    ctx.fillText(country.flag + ' ' + country.name.substring(0, 3).toUpperCase(), 40, 65);
    ctx.fillStyle = '#00FF88'; ctx.font = 'bold 45px Courier New';
    ctx.fillText(timeStr, 50, 115);
  }
  
  function createLabel(country) {
    const canvas = document.createElement('canvas');
    canvas.width = 300; canvas.height = 150; const ctx = canvas.getContext('2d');
    drawCanvas(ctx, country, '--:--');
    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
    sprite.position.copy(latLonToVec3(country.lat, country.lng, 1.3));
    sprite.scale.set(0.8, 0.4, 1); globeGroup.add(sprite);
    return { sprite, ctx, country, tex };
  }
  
  countries.forEach((c) => flagSprites.push(createLabel(c)));
  
  function updateSprites() {
    const n = new Date();
    flagSprites.forEach((item) => {
      try {
        const t = n.toLocaleTimeString('en-GB', { timeZone: item.country.tz, hour: '2-digit', minute: '2-digit' });
        drawCanvas(item.ctx, item.country, t);
        item.tex.needsUpdate = true;
      } catch(e) {}
    });
  }
  setInterval(updateSprites, 1000); updateSprites();
  
  const pauseBtn = document.getElementById('pauseBtn');
  if(pauseBtn) pauseBtn.onclick = function () { controls.autoRotate = !controls.autoRotate; this.innerText = controls.autoRotate ? '‚è∏ Pause' : '‚ñ∂ Start Rotation'; };
  
  function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
  animate();
})();

/* --- IMPROVED BOOK INITIALIZATION --- */
(function initBook() {
  const container = document.getElementById('bookContainer');
  if (!container) return;

  // 1. Wait for container to have dimensions (Mobile Fix)
  if (container.clientWidth === 0 || container.clientHeight === 0) {
    setTimeout(initBook, 100); 
    return;
  }

  const scene = new THREE.Scene();
  
  // 2. Adjust Camera for Mobile (Zoom out slightly on small screens)
  const aspect = container.clientWidth / container.clientHeight;
  const camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
  camera.position.set(0, 0, window.innerWidth < 768 ? 9 : 7); // Further back on mobile

  const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  container.appendChild(renderer.domElement);
  
  // Lighting
  scene.add(new THREE.AmbientLight(0xffffff, 0.7));
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.0); 
  dirLight.position.set(5, 10, 7); 
  scene.add(dirLight);
  
  // Book Geometry
  const geometry = new THREE.BoxGeometry(3.2, 4.6, 0.5);
  const loader = new THREE.TextureLoader();
  
  // Fallback if textures fail
  const loadTexture = (url) => {
    return loader.load(url, undefined, undefined, (err) => {
      console.warn('Texture missing:', url);
    });
  };

  const frontTexture = loadTexture('bookfront.jpg');
  const backTexture = loadTexture('bookcoverback.jpg');
  
  const materials = [ 
    new THREE.MeshLambertMaterial({ color: 0xfdfdfd }), // Right
    new THREE.MeshLambertMaterial({ color: 0x111111 }), // Left (Spine)
    new THREE.MeshLambertMaterial({ color: 0xfdfdfd }), // Top
    new THREE.MeshLambertMaterial({ color: 0xfdfdfd }), // Bottom
    new THREE.MeshBasicMaterial({ map: frontTexture, color: 0xffffff }), // Front
    new THREE.MeshBasicMaterial({ map: backTexture, color: 0xffffff })   // Back
  ];
  
  const book = new THREE.Mesh(geometry, materials);
  const bookGroup = new THREE.Group(); 
  bookGroup.add(book); 
  scene.add(bookGroup);
  
  // Initial Position
  book.rotation.x = 0.15;
  
  // Controls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true; 
  controls.dampingFactor = 0.08; 
  controls.enablePan = false; 
  controls.enableZoom = true;
  controls.autoRotate = true; 
  controls.autoRotateSpeed = 2.0; // Faster spin for visibility
  
  // Animation Loop
  const clock = new THREE.Clock();
  function animate() { 
    requestAnimationFrame(animate); 
    const elapsed = clock.getElapsedTime();
    bookGroup.position.y = Math.sin(elapsed * 1.5) * 0.1; // Floating effect
    controls.update(); 
    renderer.render(scene, camera); 
  }
  animate();
  
  // 3. Robust Resize Handler
  const handleResize = () => {
    if (!container) return;
    const width = container.clientWidth;
    const height = container.clientHeight;
    
    // Safety check for mobile collapse
    if (width === 0 || height === 0) return;

    renderer.setSize(width, height);
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    
    // Responsive Camera distance
    camera.position.z = window.innerWidth < 768 ? 9 : 7;
  };

  window.addEventListener('resize', handleResize);
  
  // Force a resize check after a short delay to fix "Zero Height" load bugs
  setTimeout(handleResize, 500);
})();

</script>
</body>
</html>
