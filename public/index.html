<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TWU-SMC 11th Annual Leadership Conference</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<style>
    /* --- CORE STYLES --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); font-family: 'Nunito', sans-serif; color: #1a365d; overflow-x: hidden; line-height: 1.6; }
    
    .header { display: flex; align-items: center; justify-content: space-between; padding: 15px 40px; background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); box-shadow: 0 2px 20px rgba(0,0,0,0.05); }
    .logo { font-size: 1.5rem; font-weight: 900; color: #167690; }
    .nav { display: flex; gap: 20px; align-items: center; }
    .nav a { text-decoration: none; color: #167690; font-weight: 700; transition: color 0.2s; }
    .nav a:hover { color: #128fa7; }
    .viewer-count { display: none; background: #ff0000; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; align-items: center; gap: 8px; animation: pulse-red 2s infinite; }
    
    /* --- HERO & LIVE --- */
    .hero { position: relative; min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 80px 20px; transition: all 0.5s ease; overflow: hidden; }
    .hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; filter: brightness(0.6); transition: filter 0.5s ease; }
    .neural-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.2) 0%, transparent 60%); opacity: 0; animation: neural-fire 4s infinite ease-in-out; pointer-events: none; }
    @keyframes neural-fire { 0%, 100% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
    .hero-content-standard { position: relative; z-index: 5; max-width: 1200px; width: 100%; transition: opacity 0.5s ease; }
    .hero-content-live { position: relative; z-index: 10; width: 100%; max-width: 1400px; display: none; margin-top: 20px; }
    .hero h1 { font-size: 4rem; font-weight: 900; color: #167690; margin:0; }
    .hero h2 { font-size: 2rem; color: white; margin: 10px 0 30px 0; }

    /* --- LIVE GRID --- */
    .live-grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 30px; height: 70vh; min-height: 500px; }
    .video-wrapper { background: black; border-radius: 20px; overflow: hidden; border: 2px solid #333; position: relative; height: 100%; width: 100%; }
    .live-badge { position: absolute; top: 20px; left: 20px; background: #ff0000; color: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; z-index: 10; }
    .video-crop { width: 100%; height: 100%; display: block; }
    .video-crop iframe { width: 100%; height: 100%; border: none; display: block; }

    /* --- CHAT SYSTEM --- */
    .human-space-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 20px; display: flex; flex-direction: column; height: 100%; border: 1px solid rgba(255,255,255,0.3); overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .human-space-header { background: linear-gradient(135deg, #167690, #0f5c70); color: white; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .hs-title-row { display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 1.1rem; }
    .teams-link-header { color: white; text-decoration: none; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; transition: 0.2s; }
    .teams-link-header:hover { background: rgba(255,255,255,0.3); }
    .download-log { color: rgba(255,255,255,0.8); font-size: 0.8rem; cursor: pointer; text-decoration: underline; }
    
    .tab-row { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 3px; }
    .hs-tab { flex: 1; background: transparent; border: none; color: rgba(255,255,255,0.7); padding: 8px; font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.2s; font-size: 0.9rem; }
    .hs-tab.active { background: white; color: #167690; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    .human-space-messages { flex: 1; padding: 20px; overflow-y: auto; display: none; flex-direction: column; gap: 12px; font-size: 0.95rem; background: #f0f4f8; min-height: 0; }
    .human-space-messages.active { display: flex; }
    
    .login-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
    .coi-note { font-size: 0.75rem; opacity: 0.6; margin-top: 20px; font-style: italic; border-top: 1px solid #eee; padding-top: 10px; max-width: 80%; color: #666; }
    
    .msg { padding: 10px 15px; border-radius: 12px; background: white; align-self: flex-start; max-width: 90%; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-bottom-left-radius: 2px; position: relative; margin-bottom: 5px; }
    .msg.me { background: #167690; color: white; align-self: flex-end; border-bottom-left-radius: 12px; border-bottom-right-radius: 2px; }
    .msg-meta { font-size: 0.7rem; opacity: 0.6; margin-bottom: 4px; display: block; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .qa-thread { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .qa-question { font-weight: bold; color: #2d3748; margin-bottom: 8px; font-size: 1rem; display: block; }
    .qa-replies { margin-top: 10px; padding-left: 15px; border-left: 3px solid #e2e8f0; font-size: 0.9rem; display: flex; flex-direction: column; gap: 8px; }
    .qa-reply-item { background: #f8f9fa; padding: 10px; margin-top: 5px; border-radius: 8px; border-left: 3px solid #ccc; font-size: 0.95rem; }
    
    .human-space-input { padding: 15px; background: white; border-top: 1px solid #eee; }
    .reaction-bar { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; }
    .reaction-btn { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 20px; padding: 6px 12px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; color: #2d3748; font-weight: 600; }
    .reaction-btn:hover { background: #167690; color: white; transform: translateY(-2px); }
    
    .input-row { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; outline: none; transition: 0.2s; font-family: inherit; }
    .chat-input:focus { border-color: #167690; }
    .send-btn { background: #167690; color: white; border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
    .login-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; outline: none; }
    .join-btn { background: linear-gradient(135deg, #167690, #0f5c70); color: white; padding: 15px 30px; border-radius: 30px; border: none; font-weight: 800; cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 10px; box-shadow: 0 5px 15px rgba(22, 118, 144, 0.3); transition: 0.2s; }
    
    .teams-backup { background: linear-gradient(135deg, #1a0000, #000); padding: 40px; text-align: center; color: white; height: 100%; display: flex; flex-direction: column; justify-content: center; border-radius: 20px; }
    
    /* --- GLOBAL SECTION --- */
    .global-connect-section { position: relative; z-index: 5; background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 50%, #000000 100%); padding: 80px 40px; display: flex; flex-wrap: wrap; justify-content: center; gap: 60px; max-width: 1400px; margin: 0 auto; }
    
    .globe-wrapper { 
        width: 500px; height: 500px; position: relative; 
        border-radius: 50%; background: radial-gradient(circle at 40% 40%, #1e2636 0%, #000000 90%); 
        border: 4px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        overflow: hidden; 
        z-index: 10; transform: translateZ(0); 
    }
    #heroGlobeContainer { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; }
    .pause-btn { background: #167690; color: white; padding: 8px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
    
    .times-wrapper { flex: 1; min-width: 350px; max-width: 600px; }
    .globe-times-stack { display: flex; flex-direction: column; gap: 12px; }
    .globe-time-item { background: white; padding: 15px 25px; border-radius: 16px; border: 1px solid #edf2f7; border-left: 6px solid #ddd; display: grid; grid-template-columns: 1.5fr 1.5fr 1fr; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: transform 0.2s; }
    .globe-time-item:hover { transform: translateX(5px); }
    .card-identity { display: flex; align-items: center; gap: 15px; }
    .globe-flag { font-size: 1.8rem; }
    .globe-name { font-weight: 800; color: #2d3748; font-size: 1.1rem; }
    .card-stats { display: flex; align-items: center; gap: 15px; color: #718096; font-size: 0.85rem; font-weight: 600; }
    .stat-pill { display: flex; align-items: center; gap: 6px; background: #f7fafc; padding: 4px 10px; border-radius: 20px; }
    .globe-time { font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.4rem; color: #ff6b35; text-align: right; }
    
    /* --- SYNOPSIS --- */
    .section { padding: 80px 40px; max-width: 1200px; margin: 0 auto; text-align: center; }
    .section-header { font-size: 2.5rem; color: #167690; margin-bottom: 40px; font-weight:900; }
    .synopsis-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 60px; align-items: center; max-width: 1200px; margin: 0 auto; }
    .synopsis-card { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.05); text-align: left; position: relative; overflow: hidden; transition: all 0.3s ease; }
    .synopsis-expanded { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
    .synopsis-expanded.open { max-height: 3000px; }
    .synopsis-expanded h3 { font-size: 1.35rem; color: #265057; margin-top: 25px; margin-bottom: 15px; }
    .synopsis-expanded blockquote { margin: 25px 0; padding: 20px; background: #f7f9ff; border-left: 6px solid #128fa7; font-size: 1.15rem; color: #265057; font-style: italic; }
    
    .expand-btn { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 25px; padding: 12px 30px; background: #167690; color: white; border: none; border-radius: 25px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; width: 100%; }
    .expand-btn:hover { background: #128fa7; transform: translateY(-2px); }
    .expand-btn .material-icons-round { transition: transform 0.3s ease; }
    .expand-btn.open .material-icons-round { transform: rotate(180deg); }
    
    .agenda-table { width: 100%; border-collapse: collapse; text-align: left; }
    .agenda-table tr { transition: background 0.2s; }
    .agenda-table tr:hover { background: #f7fafc; }
    
    .content-box { background: white; padding: 60px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.05); text-align: left; font-size: 1.1rem; }
    .pdf-preview { position: relative; width: 100%; height: 0; padding-bottom: 75%; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #ddd; background: #525659; margin-bottom: 20px; }
    .pdf-btn { display: inline-block; background: #167690; color: white; padding: 15px 30px; border-radius: 30px; text-decoration: none; font-weight: bold; margin-top: 20px; transition: 0.2s; }

    /* --- ADMIN PANEL: ALWAYS VISIBLE --- */
    .admin-panel { display: flex; position: fixed; bottom: 20px; right: 20px; z-index: 9999; gap: 10px; flex-direction: column; }
    .admin-btn { padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: all 0.3s; }
    .btn-live { background: #333; color: white; } 
    /* KILL SWITCH: HIDDEN BY DEFAULT (Shown only via JS if Admin & Live) */
    .btn-kill { background: #ff0000; color: white; display: none; }

    /* REPLY OVERLAY: INSIDE THE CONTAINER */
    #replyOverlay { 
        display:none; 
        position:absolute; 
        bottom:0; 
        left:0; 
        width:100%; 
        background:#f8f9fa; 
        border-top:1px solid #ddd; 
        padding:15px; 
        z-index: 50; 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    }
    
    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    #bookContainer { width: 100%; height: 500px; min-height: 400px; position: relative; background: radial-gradient(circle at 50% 50%, #2c3e50 0%, #000000 100%); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

    /* --- MOBILE RESPONSIVE --- */
    @media screen and (max-width: 768px) {
        html, body { overflow-x: hidden; width: 100%; position: relative; }
        .header { flex-direction: column; padding: 15px; gap: 15px; }
        .nav { flex-wrap: wrap; justify-content: center; gap: 15px; }
        .logo { font-size: 1.3rem; text-align: center; }
        .viewer-count { display: flex !important; margin-bottom: 10px; }
        .hero h1 { font-size: 2.2rem; line-height: 1.2; padding: 0 10px; }
        .hero h2 { font-size: 1.2rem; margin-bottom: 20px; }
        .hero { min-height: 60vh; padding: 40px 15px; }
        .synopsis-grid { display: flex !important; flex-direction: column-reverse !important; gap: 20px !important; }
        .synopsis-card { width: 100% !important; padding: 20px !important; margin: 0 !important; }
        #bookContainer { width: 100% !important; height: 350px !important; max-width: 350px !important; margin: 0 auto !important; display: block !important; position: relative; }
        .live-grid { display: flex !important; flex-direction: column; height: auto !important; gap: 15px; }
        .video-wrapper { width: 100% !important; height: auto !important; aspect-ratio: 16 / 9; min-height: 220px; }
        .human-space-container { width: 100% !important; height: 600px !important; border-left: none; border-top: 1px solid #ddd; }
        .global-connect-section { flex-direction: column; padding: 40px 15px; gap: 20px; }
        .globe-wrapper { width: 280px !important; height: 280px !important; margin: 0 auto 20px auto; border-radius: 50% !important; overflow: hidden !important; }
        .times-wrapper { width: 100% !important; max-width: 100% !important; }
        .globe-times-stack { display: flex !important; flex-direction: row !important; overflow-x: auto; gap: 15px; padding-bottom: 20px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .globe-time-item { flex: 0 0 85%; scroll-snap-align: center; flex-direction: column; align-items: center; text-align: center; padding: 20px; gap: 10px; border-right: 1px solid #eee; margin-right: 0; }
        .card-identity { flex-direction: column; gap: 5px; }
        .globe-time { font-size: 1.4rem; text-align: center; width: 100%; margin-top: 5px; }
        .card-stats { display: flex; align-items: center; justify-content: center; gap: 15px; width: 100%; }
        #pauseBtn { position: relative !important; bottom: auto !important; left: auto !important; transform: none !important; margin: 20px auto 0 auto; display: block; width: 200px; }
    }
</style>
</head>
<body>

<div class="admin-panel" id="adminPanel">
  <button class="admin-btn btn-live" id="liveToggle">üî¥ GO LIVE</button>
  <button class="admin-btn btn-kill" id="killSwitch">‚ö†Ô∏è END STREAM</button>
</div>

<header class="header">
  <div class="logo">TWU-SMC 11th Annual Leadership Conference</div>
  <nav class="nav">
    <div class="viewer-count" id="viewerCount">
      <span class="material-icons-round">visibility</span>
      <span id="countNum">0</span> Watching
    </div>
    <a href="#">Home</a>
    <a href="#synopsis">About</a>
    <a href="#agenda">Agenda</a>
    <a href="#resources">Resources</a>
  </nav>
</header>

<section class="hero">
  <img src="humanintelligence.png" alt="Background" class="hero-bg" id="heroBg">
  <div class="neural-overlay"></div>
  <div class="hero-content-standard" id="heroStandard">
    <h1>The Fifth Intelligence</h1>
    <h2>Integrating the Human Factor</h2>
  </div>
  
  <div class="hero-content-live" id="heroLive" style="display:none;">
    <div class="live-grid">
      <div class="video-wrapper" id="vidWrap">
        <div class="live-badge">üî¥ LIVE</div>
        <div class="video-crop">
          <iframe id="feed" src="https://www.youtube.com/embed/97vsV_lwXPo?autoplay=0&controls=1&mute=0&playsinline=1&modestbranding=1&rel=0" width="100%" height="100%" title="Live Stream" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
      <div class="human-space-container">
        <div class="human-space-header">
          <div class="hs-title-row">
            <div style="display:flex; align-items:center; gap:10px;"><span class="material-icons-round">forum</span> The Human Space</div>
            <div style="display:flex; gap:10px;">
              <a href="https://teams.microsoft.com/meet/25727590322372?p=Toyeb2xMWy8NeEJiA2" target="_blank" class="teams-link-header"><span class="material-icons-round" style="font-size:16px;">videocam</span> Teams</a>
              <span id="downloadLogBtn" class="download-log">‚¨á LOG</span>
            </div>
          </div>
          <div class="tab-row">
            <button class="hs-tab active" onclick="switchTab('chat')">üí¨ Chat Lounge</button>
            <button class="hs-tab" onclick="switchTab('qa')">‚ùì Q&A Forum</button>
          </div>
        </div>
        
        <div class="login-overlay" id="chatLogin">
          <h3 style="font-size:1.5rem; color:#167690; margin-bottom:10px;">Enter the Human Space</h3>
          <p style="font-size:1rem; margin-bottom:30px; color:#666;">Secure, Proprietary, Connected.</p>
          <input type="text" id="chatName" class="login-input" placeholder="Your Name" maxlength="20">
          <select id="chatCountry" class="login-input">
            <option value="" disabled selected>Select Your Region</option>
            <option value="India">üáÆüá≥ India</option>
            <option value="Canada">üá®üá¶ Canada</option>
            <option value="Thailand">üáπüá≠ Thailand</option>
            <option value="USA">üá∫üá∏ USA</option>
            <option value="Other">üåç Global</option>
          </select>
          <button class="join-btn" onclick="joinChat()">Join Conversation</button>
          <div class="coi-note">Inspired by the <strong>Community of Inquiry (CoI)</strong> framework.</div>
        </div>

        <div class="human-space-messages active" id="chatTab">
             <div style="text-align:center; opacity:0.6; margin-top:40px; padding:20px;">
                <span class="material-icons-round" style="font-size:3rem; color:#cbd5e0;">public</span>
                <br><br><strong>Global Lounge</strong><br>Say hello, share reactions, and connect.
            </div>
        </div>
        <div class="human-space-messages" id="qaTab">
            <div style="text-align:center; opacity:0.6; margin-top:40px; padding:20px;">
                <span class="material-icons-round" style="font-size:3rem; color:#cbd5e0;">psychology_alt</span>
                <br><br><strong>Q&A Forum</strong><br>Post deep questions here. Faculty will respond.
            </div>
        </div>
        
        <div class="human-space-input">
          <div class="reaction-bar" id="reactionBar"></div>
          <div class="input-row">
            <input type="text" id="msgInput" class="chat-input" placeholder="Share your thoughts..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()"><span class="material-icons-round">send</span></button>
          </div>
        </div>

        <div id="replyOverlay">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong style="color:#167690;">Reply to Thread</strong>
                <span onclick="closeReply()" style="cursor:pointer; color:#666; font-weight:bold;">‚úï</span>
            </div>
            <input type="text" id="replyInput" placeholder="Type answer..." style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px;">
            <button onclick="submitReply()" style="width:100%; background:#167690; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">Post Reply</button>
        </div>

      </div>
    </div>
  </div>
</section>

<section class="global-connect-section">
  <div class="globe-wrapper">
    <div id="heroGlobeContainer"></div> 
  </div>
  <button class="pause-btn" id="pauseBtn" style="display:none;">‚è∏ Pause</button>

  <div class="times-wrapper">
    <h3 style="font-size: 2rem; color:#ffffff; margin-bottom:30px; font-weight:900;">üåç Global Community</h3>
    <div class="globe-times-stack" id="timeStack"></div>
  </div>
</section>

<section class="section" id="synopsis">
  <h2 class="section-header">Conference Overview</h2>
  <div class="synopsis-grid">
    <div class="synopsis-card">
      <div class="synopsis-preview">
        <p style="margin-bottom: 20px;">
          Join us as <strong>Dr. Laird</strong>, Vice President of Innovation at TWU, unveils concepts from his new book on <strong>"Fifth Intelligence."</strong>
        </p>
        <p style="font-size: 1.05rem; color: #265057;">Transformative insights from global thought leaders.</p>
      </div>
      <div class="synopsis-expanded" id="synopsisExpanded">
        <h3 style="font-size: 1.5rem; color: #167690; margin-top: 30px; margin-bottom: 15px;">Integrating the Human Factor</h3>
        <p style="margin-bottom: 30px;">This conference explores how higher-order human thinking can steer AI development.</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #167690;">
            <h4 style="color: #2d3748; margin-bottom: 5px; font-size: 1rem;">Emotional Intelligence</h4>
            <p style="font-size: 0.9rem; color: #4a5568;">Empathy & Perspective-Taking</p>
          </div>
          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #48bb78;">
            <h4 style="color: #2d3748; margin-bottom: 5px; font-size: 1rem;">Truth & Transparency</h4>
            <p style="font-size: 0.9rem; color: #4a5568;">Accountability in Systems</p>
          </div>
          <div style="background: #f7fafc; padding: 20px; border-radius: 15px; border-left: 5px solid #ed8936;">
            <h4 style="color: #2d3748; margin-bottom: 5px; font-size: 1rem;">Critical Consciousness</h4>
            <p style="font-size: 0.9rem; color: #4a5568;">Higher-Order Thinking</p>
          </div>
        </div>
        <blockquote><strong>Key Message:</strong> AI amplifies capabilities, but human sensitivity and ethical grounding must lead the way.</blockquote>
      </div>
      <button class="expand-btn" id="expandBtn"><span>Read More</span><span class="material-icons-round">expand_more</span></button>
    </div>
    <div style="width: 100%; display: flex; justify-content: center; align-items: center;">
      <div id="bookContainer"></div>
    </div>
  </div>
</section>

<section class="section" id="agenda">
  <h2 class="section-header">Agenda</h2>
  <div class="content-box" style="padding:0; overflow:hidden;">
    <table class="agenda-table" style="width:100%; border-collapse:collapse;">
      <tr style="background:#167690; color:white;"><th style="padding:15px;">Time (IST)</th><th style="padding:15px;">Session</th></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">10:00 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Welcome & Opening</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">10:30 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Keynote: Fifth Intelligence</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">11:15 AM</td><td style="padding:15px; border-bottom:1px solid #eee;">Workshop: Human-AI Integration</td></tr>
      <tr><td style="padding:15px; border-bottom:1px solid #eee;">03:30 PM</td><td style="padding:15px; border-bottom:1px solid #eee;">Closing</td></tr>
    </table>
  </div>
</section>

<section class="section" id="resources">
  <h2 class="section-header">Resources</h2>
  <div class="content-box" style="text-align:center; padding: 40px 20px;">
    <h3>Conference Brochure</h3>
    <p style="margin-bottom:20px; opacity:0.8;">View, scroll, and download the full schedule below.</p>
    <div class="pdf-preview">
      <iframe src="GLOB%20SMC%20Leadership%20Conference%202025_Brochure_Final5.pdf#toolbar=1&view=FitH" width="100%" height="100%" style="border:none; position:absolute; top:0; left:0;"></iframe>
    </div>
    <a href="GLOB%20SMC%20Leadership%20Conference%202025_Brochure_Final5.pdf" download class="pdf-btn"><span class="material-icons-round" style="vertical-align:middle; margin-right:5px;">download</span> Download PDF</a>
  </div>
</section>

<script>
let s;
try {
  s = io();
} catch (e) {
  console.warn("OFFLINE");
  s = { emit: () => {}, on: () => {} };
}

// Initial requests
s.emit('r', Intl.DateTimeFormat().resolvedOptions().timeZone);
s.emit('getHistory');

let myName = "", myCountry = "", currentTab = "chat", rawChatData = [], rawQaData = [];
const isAdmin = new URLSearchParams(window.location.search).get('m') === 'a';

// DOM
const hS      = document.getElementById('heroStandard'),
      hL      = document.getElementById('heroLive'),
      hB      = document.getElementById('heroBg'),
      vC      = document.getElementById('viewerCount'),
      cN      = document.getElementById('countNum'),
      kS      = document.getElementById('killSwitch'),
      lT      = document.getElementById('liveToggle'),
      chatTab = document.getElementById('chatTab'),
      qaTab   = document.getElementById('qaTab'),
      msgInput= document.getElementById('msgInput'),
      stackEl = document.getElementById('timeStack');

// Popups
const popupsHTML = `
<div id="pledgeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:35px; border-radius:15px; max-width:550px; width:90%; text-align:center; color:#333; box-shadow:0 20px 50px rgba(0,0,0,0.5);">
    <div style="font-size:3rem; margin-bottom:10px;">‚òï</div>
    <h2 style="color:#167690; margin-bottom:15px; font-weight:800;">Welcome to Human Space</h2>
    <p style="font-size:1.1rem; line-height:1.6; margin-bottom:25px; color:#444;">We invite you to practice <strong>inclusive leadership</strong>.</p>
    <div style="background:#f1f9fc; border-left:5px solid #167690; padding:20px; text-align:left; margin-bottom:30px; border-radius:0 10px 10px 0;">
      <strong style="color:#0e4b5b; display:block; margin-bottom:10px; font-size:1.1rem;">‚ù§Ô∏è Our Community Heart:</strong>
      <ul style="margin:0; padding-left:20px; color:#555;">
        <li>Scholarly yet Casual</li>
        <li>Collaboration over Debate</li>
      </ul>
    </div>
    <button onclick="acceptPledge()" style="background:linear-gradient(135deg, #167690, #0e4b5b); color:white; border:none; padding:15px 40px; font-size:1.2rem; border-radius:30px; cursor:pointer; font-weight:bold;">I Agree & Enter</button>
  </div>
</div>

<div id="reactPicker" style="display:none; position:absolute; background:white; border-radius:30px; padding:5px 10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); z-index:1000; border:1px solid #eee;">
  <span onclick="pickReact('‚ù§Ô∏è')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">‚ù§Ô∏è</span>
  <span onclick="pickReact('üòÇ')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üòÇ</span>
  <span onclick="pickReact('üëç')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üëç</span>
  <span onclick="pickReact('üî•')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">üî•</span>
  <span onclick="closeReact()" style="cursor:pointer; font-size:1rem; margin-left:8px; color:#999;">‚úï</span>
</div>`;
document.body.insertAdjacentHTML('beforeend', popupsHTML);

// Top reaction bar ‚Äì NOW sends standalone emoji messages
const EMOJI_SETS = {
  chat: [
    { icon: 'üëè', label: 'Clap' },
    { icon: 'üî•', label: 'Fire' },
    { icon: '‚ù§Ô∏è', label: 'Love' },
    { icon: 'üòÇ', label: 'Haha' }
  ]
};

function updateReactionBar(type) {
  const bar = document.getElementById('reactionBar');
  if (!bar) return;

  if (type === 'qa') {
    bar.style.display = 'none';
    bar.innerHTML = '';
    return;
  }

  bar.style.display = 'flex';
  bar.innerHTML = EMOJI_SETS.chat.map(e =>
    `<button class="reaction-btn"
             onclick="s.emit('chatMsg', { user: myName, text: '${e.icon}' })"
             title="${e.label}"
             aria-label="${e.label}">
       <span role="img" aria-hidden="true">${e.icon}</span>
     </button>`
  ).join('');
}
updateReactionBar('chat');

// Synopsis toggle
document.getElementById('expandBtn').addEventListener('click', function () {
  const c = document.getElementById('synopsisExpanded');
  c.classList.toggle('open');
  this.classList.toggle('open');
  this.querySelector('span').textContent = c.classList.contains('open') ? 'Read Less' : 'Read More';
});

// Live controls
if (lT) lT.onclick = () => s.emit('x');
if (kS) kS.onclick = () => {
  const p = prompt("Pass:");
  if (p) s.emit('k', p);
};

// =====================
// SOCKET LISTENERS
// =====================

s.on('z', st => {
  const live = st && typeof st.isLive === 'boolean' ? st.isLive : false;
  toggleLiveUI(live);
  if (st && st.isKilled) killStreamUI();
});

s.on('t', c => { if (cN) cN.innerText = c; });

s.on('r', d => {
  countries.forEach((c, i) => {
    const el = document.getElementById(`count-${i}`);
    if (el) el.innerText = d[c.tz] || 0;
  });
});

s.on('chatIncoming', d => {
  rawChatData.push(d);
  addMessage('chat', d.user, d.text, (d.user === myName), d.country, d.id, d.reactions, d.flags);
});

s.on('qaIncoming', d => {
  rawQaData.push(d);
  addQaThread(d.user, d.text, (d.user === myName), d.country, d.id, d.reactions, d.flags);
});

s.on('qaReplyIncoming', d => {
  const t = rawQaData.find(x => x.id === d.threadId);
  if (t) { if (!t.replies) t.replies = []; t.replies.push(d); }
  addQaReplyUI(d.threadId, d.id, d.user, d.text, d.reactions);
});

// reaction updates from server (Q&A)
s.on('qaReactionUpdate', d => {
  const thread = rawQaData.find(t => t.id === d.threadId);
  if (thread) thread.reactions = d.reactions;
  const box = document.getElementById('react-box-' + d.threadId);
  if (box) box.innerHTML = renderReactionButtons(d.threadId, d.reactions);
});

s.on('qaReplyReactionUpdate', d => {
  const thread = rawQaData.find(t => t.id === d.threadId);
  if (thread && thread.replies) {
    const reply = thread.replies.find(r => r.id === d.replyId);
    if (reply) reply.reactions = d.reactions;
  }
  const box = document.getElementById('reply-reacts-' + d.replyId);
  if (box) box.innerHTML = renderReplyReactionButtons(d.threadId, d.replyId, d.reactions);
});

// chat reactions anchored to message
s.on('chatReactionUpdate', d => {
  const box = document.getElementById('chat-reacts-' + d.id);
  if (box) box.innerHTML = renderChatReactions(d.id, d.reactions);
});

// History
s.on('history', d => {
  if (d.chat) {
    d.chat.forEach(m => {
      addMessage('chat', m.user, m.text, (myName && m.user === myName), m.country, m.id, m.reactions, m.flags);
    });
  }
  if (d.qa) {
    d.qa.forEach(q => {
      addQaThread(q.user, q.text, (myName && q.user === myName), q.country, q.id, q.reactions, q.flags);
      if (q.replies) q.replies.forEach(r => addQaReplyUI(q.id, r.id, r.user, r.text, r.reactions));
    });
  }
});

// DELETE HANDLERS
s.on('chatDeleted', function (id) {
  const el = document.getElementById(id);
  if (el && el.parentNode) el.parentNode.removeChild(el);
  if (Array.isArray(rawChatData)) {
    rawChatData = rawChatData.filter(m => m.id !== id);
  }
});

s.on('qaDeleted', function (id) {
  const el = document.getElementById(id);
  if (el && el.parentNode) el.parentNode.removeChild(el);
  if (Array.isArray(rawQaData)) {
    rawQaData = rawQaData.filter(t => t.id !== id);
  }
});

s.on('qaReplyDeleted', function ({ threadId, replyId }) {
  const replyEl = document.getElementById('reply-' + replyId);
  if (replyEl && replyEl.parentNode) replyEl.parentNode.removeChild(replyEl);

  const thread = Array.isArray(rawQaData)
    ? rawQaData.find(t => t.id === threadId)
    : null;
  if (thread && Array.isArray(thread.replies)) {
    thread.replies = thread.replies.filter(r => r.id !== replyId);
  }
});

// LIVE UI
function toggleLiveUI(isLive) {
  hS.style.display = isLive ? 'none' : 'block';
  hL.style.display = isLive ? 'block' : 'none';
  if (hB) hB.style.filter = isLive ? 'brightness(0.2)' : 'brightness(0.6)';
  vC.style.display = isLive ? 'flex' : 'none';
  if (lT) {
    lT.innerHTML = isLive ? 'üü¢ LIVE' : 'üî¥ GO LIVE';
    lT.style.background = isLive ? '#00cc00' : '#333';
  }
  if (kS) kS.style.display = (isLive && isAdmin) ? 'block' : 'none';
}
function killStreamUI() {
  if (hL) hL.innerHTML = `<div class="teams-backup"><h2>Stream Ended</h2><a href="#">Join Teams</a></div>`;
}

// World stack + weather
const countries = [
  { name: 'India',     flag: 'üáÆüá≥', tz: 'Asia/Kolkata',       lat: 13.0827, lng: 80.2707,  color: '#FF9933' },
  { name: 'Canada',    flag: 'üá®üá¶', tz: 'America/Vancouver',  lat: 49.2827, lng: -123.1207, color: '#ff0000' },
  { name: 'Thailand',  flag: 'üáπüá≠', tz: 'Asia/Bangkok',       lat: 13.7563, lng: 100.5018, color: '#ffcc00' },
  { name: 'Europe',    flag: 'üá™üá∫', tz: 'Europe/Paris',       lat: 48.8566, lng: 2.3522,   color: '#0000FF' },
  { name: 'UK',        flag: 'üá¨üáß', tz: 'Europe/London',      lat: 51.5074, lng: -0.1278,  color: '#191970' },
  { name: 'USA',       flag: 'üá∫üá∏', tz: 'America/New_York',   lat: 40.7128, lng: -74.0060, color: '#003366' },
  { name: 'Singapore', flag: 'üá∏üá¨', tz: 'Asia/Singapore',     lat: 1.3521,  lng: 103.8198, color: '#EE2536' },
  { name: 'Malaysia',  flag: 'üá≤üáæ', tz: 'Asia/Kuala_Lumpur',  lat: 3.1390,  lng: 101.6869, color: '#FFD700' },
  { name: 'Nigeria',   flag: 'üá≥üá¨', tz: 'Africa/Lagos',       lat: 6.5244,  lng: 3.3792,   color: '#008751' },
  { name: 'Vietnam',   flag: 'üáªüá≥', tz: 'Asia/Ho_Chi_Minh',   lat: 10.8231, lng: 106.6297, color: '#DA251D' },
  { name: 'Japan',     flag: 'üáØüáµ', tz: 'Asia/Tokyo',         lat: 35.6762, lng: 139.6503, color: '#BC002D' },
  { name: 'Dubai',     flag: 'üá¶üá™', tz: 'Asia/Dubai',         lat: 25.2048, lng: 55.2708,  color: '#00732F' }
];

if (stackEl && stackEl.innerHTML.trim() === "") countries.forEach((c, i) => {
  stackEl.innerHTML += `
    <div class="globe-time-item" style="border-left-color:${c.color}">
      <div class="card-identity">
        <span class="globe-flag">${c.flag}</span>
        <span class="globe-name">${c.name}</span>
      </div>
      <div class="card-stats">
        <div class="stat-pill">
          <span class="material-icons-round">visibility</span>
          <span id="count-${i}">0</span>
        </div>
        <div class="stat-pill">
          <span class="material-icons-round" id="w-icon-${i}">wb_sunny</span>
          <span id="weather-${i}" style="margin-left:5px;">--¬∞C</span>
        </div>
      </div>
      <div class="globe-time" id="stack-time-${i}">--:--</div>
    </div>`;
});

function updateStackTimes() {
  const n = new Date();
  countries.forEach((c, i) => {
    try {
      const e = document.getElementById(`stack-time-${i}`);
      if (e) e.innerText = n.toLocaleTimeString('en-GB', { timeZone: c.tz, hour: '2-digit', minute: '2-digit' });
    } catch(e) {}
  });
}
setInterval(updateStackTimes, 1000);
updateStackTimes();

// WEATHER
async function fetchRealWeather() {
  countries.forEach(async (c, i) => {
    try {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lng}&current_weather=true`);
      const data = await res.json();
      if (data.current_weather) {
        let icon = 'wb_sunny';
        const code = data.current_weather.weathercode;
        if (code >= 1 && code <= 3) icon = 'cloud';
        else if (code >= 45 && code <= 48) icon = 'blur_on';
        else if (code >= 51 && code <= 67) icon = 'opacity';
        else if (code >= 71 && code <= 77) icon = 'ac_unit';
        else if (code >= 80 && code <= 82) icon = 'grain';
        else if (code >= 95) icon = 'flash_on';
        const elTemp = document.getElementById(`weather-${i}`);
        const elIcon = document.getElementById(`w-icon-${i}`);
        if (elTemp) elTemp.innerText = `${Math.round(data.current_weather.temperature)}¬∞C`;
        if (elIcon) elIcon.innerText = icon;
      }
    } catch (err) {}
  });
}
fetchRealWeather();
setInterval(fetchRealWeather, 900000);

// TAB + chat / Q&A send
function switchTab(name, evt) {
  currentTab = name;
  document.querySelectorAll('.hs-tab').forEach(b => b.classList.remove('active'));
  if (evt && evt.target) evt.target.classList.add('active');
  chatTab.style.display = name === 'chat' ? 'flex' : 'none';
  qaTab.style.display   = name === 'qa'   ? 'flex' : 'none';
  updateReactionBar(name);
}

// join + send
function joinChat() {
  const n = document.getElementById('chatName').value;
  if (!n) return alert('Name?');
  myName = n;
  document.getElementById('chatLogin').style.display = 'none';
  document.getElementById('pledgeModal').style.display = 'flex';
}
function acceptPledge() {
  document.getElementById('pledgeModal').style.display = 'none';
  s.emit('r', Intl.DateTimeFormat().resolvedOptions().timeZone);
}

function sendMessage() {
  const t = msgInput.value;
  if (t && myName) {
    const eventName = currentTab === 'chat' ? 'chatMsg' : 'qaAsk';
    s.emit(eventName, { user: myName, text: t });
  }
  msgInput.value = '';
}
function handleEnter(e) {
  if (e.key === 'Enter') sendMessage();
}

// helper: detect emoji-only chat messages
function isEmojiOnly(text) {
  if (!text) return false;
  const trimmed = text.trim();
  const regexExp = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/gi;
  const onlyEmoji = trimmed.replace(regexExp, '').trim();
  return onlyEmoji.length === 0;
}

// Reactions picker for chat / replies
let targetReactId = null;
let targetReactType = 'chat';

function showChatReactPicker(id, event, type = 'chat') {
  targetReactId = id;
  targetReactType = type;
  const p = document.getElementById('reactPicker');
  const chatOptions = ['‚ù§Ô∏è', 'üòÇ', 'üëç', 'üî•', 'üëè'];
  const qaOptions   = ['üí°', '‚úÖ', 'üß†', '‚¨ÜÔ∏è', 'üéØ'];
  const currentOptions = (type === 'chat') ? chatOptions : qaOptions;
  let html = currentOptions.map(emoji =>
    `<span onclick="pickReact('${emoji}')" style="cursor:pointer; font-size:1.2rem; margin:0 5px;">${emoji}</span>`
  ).join('');
  html += `<span onclick="closeReact()" style="cursor:pointer; font-size:1rem; margin-left:8px; color:#999;">‚úï</span>`;
  p.innerHTML = html;
  p.style.top  = (event.clientY - 40) + 'px';
  p.style.left = (event.clientX - 40) + 'px';
  p.style.display = 'block';
}

function pickReact(e) {
  if (targetReactId && myName) {
    if (targetReactType === 'chat') {
      s.emit('chatReact', { id: targetReactId, emoji: e, user: myName });
    } else if (targetReactType === 'qaReply') {
      s.emit('qaReplyReact', { replyId: targetReactId, emoji: e, user: myName });
    }
  }
  closeReact();
}
function closeReact() {
  document.getElementById('reactPicker').style.display = 'none';
}

function renderChatReactions(id, r) {
  if (!r) return '';
  return Object.keys(r).map(e =>
    `<span style="font-size:0.8rem; margin-right:3px;">${e} ${r[e].length}</span>`
  ).join('');
}

function flagMsg(id, isMe) {
  if (!myName) return alert("Join first to flag messages.");
  if (isMe) {
    if (!confirm("Delete your own message from the chat?")) return;
    s.emit('chatFlag', { id, user: myName });
  } else {
    const ok = confirm(
      "Flag this message as inappropriate?\n\n" +
      "Disagreement is welcome, but posts that are disrespectful or harmful " +
      "may be removed when multiple people red‚Äëflag them."
    );
    if (!ok) return;
    s.emit('chatFlag', { id, user: myName });
  }
}

function addMessage(target, user, text, isMe, country, id, reactions, flags) {
  if (!chatTab || (id && document.getElementById(id))) return;

  const isSystemNotice = (user === 'üõ° Community Notice');
  const div = document.createElement('div');
  div.className = `msg ${isMe ? 'me' : ''}`;
  div.id = id;

  const isEmojiPost = isEmojiOnly(text);
  const actionIcon = isSystemNotice ? '' : (isMe ? 'üóëÔ∏è' : '‚öë');
  const hasFlagged = flags && flags.includes(myName);
  const flagColor = hasFlagged ? 'red' : 'inherit';
  const flagOpacity = hasFlagged || isMe ? '1' : '0.3';
  const flagPointer = hasFlagged ? 'default' : 'pointer';

  const reactButtonHtml = (isSystemNotice || isEmojiPost)
    ? ''
    : `<span onclick="showChatReactPicker('${id}', event, 'chat')"
              style="cursor:pointer; opacity:0.5; font-size:0.8rem; margin-right:10px;"
              title="Add Reaction">‚ûï</span>`;

  const flagHtml = (isSystemNotice || !actionIcon)
    ? ''
    : `<span id="flag-btn-${id}"
              onclick="${hasFlagged ? '' : `flagMsg('${id}', ${isMe})`}"
              style="cursor:${flagPointer}; opacity:${flagOpacity}; color:${flagColor}; font-size:0.85rem;"
              title="${isMe ? 'Delete' : 'Flag Inappropriate'}">${actionIcon}</span>`;

  div.innerHTML = `
    <span class="msg-meta">${user}</span>
    ${text}
    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
      <div id="chat-reacts-${id}" style="display:flex;">${isSystemNotice ? '' : renderChatReactions(id, reactions)}</div>
      <div>
        ${reactButtonHtml}
        ${flagHtml}
      </div>
    </div>`;
  chatTab.appendChild(div);
  chatTab.scrollTop = chatTab.scrollHeight;
}

// Q&A threads + replies

let targetQaId = null;
function openReplyUI(id) {
  targetQaId = id;
  document.getElementById('replyOverlay').style.display = 'block';
}
function closeReply() {
  document.getElementById('replyOverlay').style.display = 'none';
}
function submitReply() {
  const t = document.getElementById('replyInput').value;
  if (t) s.emit('qaReply', { threadId: targetQaId, user: myName, text: t });
  closeReply();
  document.getElementById('replyInput').value = '';
}

const EMOJI_DEF = {
  'üéì': 'Insightful',
  'üí°': 'Great Idea',
  'ü§ù': 'Agreement',
  '‚≠ê': 'Excellent',
  'üìú': 'Scholarly',
  'üß†': 'Deep'
};

function renderReactionButtons(id, r) {
  const emojis = Object.keys(EMOJI_DEF);
  return emojis.map(e => {
    const list  = (r && Array.isArray(r[e])) ? r[e] : [];
    const count = list.length;
    const iVoted = myName && list.includes(myName);
    const activeStyle = iVoted
      ? 'border:1px solid #38bdf8; background:rgba(56,189,248,0.2);'
      : 'border:1px solid #333; background:rgba(255,255,255,0.05);';
    return `<span onclick="emitReact('${id}', '${e}')"
                 title="${EMOJI_DEF[e]}"
                 aria-label="${EMOJI_DEF[e]}"
                 style="cursor:pointer; padding:4px 8px; border-radius:15px;
                        font-size:0.9rem; transition:all 0.2s; ${activeStyle}">
              <span role="img" aria-hidden="true">${e}</span> ${count}
            </span>`;
  }).join('');
}
function emitReact(id, emoji) {
  if (!myName) return alert("Please Join first to react.");
  s.emit('qaReact', { threadId: id, emoji, user: myName });
}

function flagQa(id, isMe) {
  if (!myName) return alert("Join first to flag questions.");
  const msg = isMe
    ? "Delete your own question from the Q&A?"
    : "Flag this question as inappropriate? Disagreement is OK, but harmful or disrespectful content may be removed when multiple people red‚Äëflag it.";
  if (!confirm(msg)) return;
  s.emit('qaFlag', { id, user: myName });
}

function addQaThread(user, text, isMe, country, serverId, reactions, flags) {
  if (!qaTab) return;
  if (serverId && document.getElementById(serverId)) return;

  const div = document.createElement('div');
  div.className = 'qa-thread';
  div.id = serverId;

  const isAi = (user === "ü§ñ Session Facilitator");
  const userDisplay = isAi ? `<span style="color:#ffcc00;font-weight:bold;">${user}</span>` : user;
  const bgStyle = isAi ? 'background:rgba(255,215,0,0.1); border-left:3px solid #ffcc00;' : '';

  const safeReactions = reactions || {
    'üéì':[], 'üí°':[], 'ü§ù':[], '‚≠ê':[], 'üìú':[], 'üß†':[]
  };

  const actionIcon  = isMe ? 'üóëÔ∏è' : '‚öë';
  const hasFlagged  = flags && flags.includes(myName);
  const flagColor   = hasFlagged ? 'red' : 'inherit';
  const flagOpacity = hasFlagged || isMe ? '1' : '0.3';
  const flagPointer = hasFlagged ? 'default' : 'pointer';

  div.style.cssText = bgStyle;
  div.innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <span class="qa-question">Q: ${text}</span>
      <span id="qa-flag-btn-${serverId}"
            onclick="${hasFlagged ? '' : `flagQa('${serverId}', ${isMe})`}"
            style="cursor:${flagPointer}; opacity:${flagOpacity}; color:${flagColor};"
            title="${isMe ? 'Delete' : 'Flag'}">${actionIcon}</span>
    </div>
    <div class="msg-meta">Asked by ${userDisplay} ‚Ä¢ ${country || 'Global'}</div>
    <div class="qa-reactions" id="react-box-${serverId}"
         style="margin:5px 0; display:flex; gap:8px;">
      ${renderReactionButtons(serverId, safeReactions)}
    </div>
    <div class="qa-replies" id="replies-${serverId}"></div>
    <div style="margin-top:8px; padding-top:5px; border-top:1px solid #eee;">
      <span style="cursor:pointer; color:#167690; font-weight:800; font-size:0.8rem;"
            onclick="openReplyUI('${serverId}')">üí¨ REPLY</span>
    </div>`;
  qaTab.appendChild(div);
  qaTab.scrollTop = qaTab.scrollHeight;
}

function renderReplyReactionButtons(threadId, replyId, r) {
  const emojis = Object.keys(EMOJI_DEF);
  return emojis.map(e => {
    const list  = (r && Array.isArray(r[e])) ? r[e] : [];
    const count = list.length;
    const iVoted = myName && list.includes(myName);
    const activeStyle = iVoted
      ? 'opacity:1; background:rgba(22,118,144,0.1);'
      : 'opacity:0.6;';
    const border = iVoted ? '1px solid #167690' : '1px solid transparent';
    return `<span onclick="emitReplyReact('${threadId}', '${replyId}', '${e}')"
                 title="${EMOJI_DEF[e]}"
                 aria-label="${EMOJI_DEF[e]}"
                 style="cursor:pointer; font-size:0.75rem; padding:2px 6px;
                        border-radius:10px; ${activeStyle} border:${border};
                        transition:0.2s;">
              <span role="img" aria-hidden="true">${e}</span> ${count || ''}
            </span>`;
  }).join('');
}

function emitReplyReact(threadId, replyId, emoji) {
  if (!myName) return alert("Join to react!");
  s.emit('qaReplyReact', { threadId, replyId, emoji, user: myName });
}

function flagQaReply(threadId, replyId, isMe) {
  if (!myName) return alert("Join first to flag replies.");
  const msg = isMe
    ? "Delete your own reply from the Q&A?"
    : "Flag this reply as inappropriate? It may be removed after multiple red‚Äëflags.";
  if (!confirm(msg)) return;
  s.emit('qaReplyFlag', { threadId, replyId, user: myName });
}

function addQaReplyUI(threadId, replyId, user, text, reactions) {
  const box = document.getElementById(`replies-${threadId}`);
  if (!box) return;
  if (document.getElementById(`reply-${replyId}`)) return;

  const div = document.createElement('div');
  div.className = 'qa-reply-item';
  div.id = `reply-${replyId}`;

  const safeReacts = reactions || {
    'üéì':[], 'üí°':[], 'ü§ù':[], '‚≠ê':[], 'üìú':[], 'üß†':[]
  };

  const isMe = (user === myName);
  const actionIcon  = isMe ? 'üóëÔ∏è' : '‚öë';
  const title       = isMe ? 'Delete reply' : 'Flag reply';

  div.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div><strong style="color:#167690">${user}:</strong> ${text}</div>
      <span style="cursor:pointer; font-size:0.8rem;"
            title="${title}"
            onclick="flagQaReply('${threadId}', '${replyId}', ${isMe})">${actionIcon}</span>
    </div>
    <div id="reply-reacts-${replyId}" style="margin-top:5px; display:flex; gap:5px;">
      ${renderReplyReactionButtons(threadId, replyId, safeReacts)}
    </div>`;
  box.appendChild(div);
}

// Globe init
(function initGlobe() {
  const container = document.getElementById('heroGlobeContainer');
  if (!container) return;

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
  camera.position.set(0, 0, 4.8);

  const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.8;

  scene.add(new THREE.AmbientLight(0xffffff, 0.8));
  const dLight = new THREE.DirectionalLight(0xffffff, 0.7);
  dLight.position.set(1, 1, 1);
  scene.add(dLight);

  const globeGroup = new THREE.Group();
  scene.add(globeGroup);
  globeGroup.rotation.y = 0;
  globeGroup.rotation.x = 0.2;

  new THREE.TextureLoader().load(
    'https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Land_ocean_ice_2048.jpg/1024px-Land_ocean_ice_2048.jpg',
    tex => {
      const geo = new THREE.SphereGeometry(1, 64, 64);
      const mat = new THREE.MeshPhongMaterial({ map: tex, specular: 0x111111, shininess: 5 });
      globeGroup.add(new THREE.Mesh(geo, mat));
    }
  );

  const flagSprites = [];
  function latLonToVec3(lat, lon, r) {
    const phi = (90 - lat) * (Math.PI / 180);
    const theta = (lon + 180) * (Math.PI / 180);
    return new THREE.Vector3(
      -r * Math.sin(phi) * Math.cos(theta),
      r * Math.cos(phi),
      r * Math.sin(phi) * Math.sin(theta)
    );
  }

  function drawCanvas(ctx, country, timeStr) {
    ctx.clearRect(0, 0, 300, 150);
    ctx.fillStyle = 'rgba(10,16,30,0.85)';
    ctx.beginPath();
    const r = 20, x = 10, y = 10, w = 280, h = 130;
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
    ctx.fill();
    ctx.lineWidth = 6;
    ctx.strokeStyle = country.color;
    ctx.stroke();

    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 38px Arial';
    ctx.fillText(country.flag + ' ' + country.name.substring(0, 3).toUpperCase(), 40, 65);

    ctx.fillStyle = '#00FF88';
    ctx.font = 'bold 45px Courier New';
    ctx.fillText(timeStr, 50, 115);
  }

  function createLabel(country) {
    const canvas = document.createElement('canvas');
    canvas.width = 300; canvas.height = 150;
    const ctx = canvas.getContext('2d');
    drawCanvas(ctx, country, '--:--');
    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
    sprite.position.copy(latLonToVec3(country.lat, country.lng, 1.3));
    sprite.scale.set(0.8, 0.4, 1);
    globeGroup.add(sprite);
    return { sprite, ctx, country, tex };
  }

  countries.forEach(c => flagSprites.push(createLabel(c)));

  function updateSprites() {
    const n = new Date();
    flagSprites.forEach(item => {
      try {
        const t = n.toLocaleTimeString('en-GB', {
          timeZone: item.country.tz,
          hour: '2-digit',
          minute: '2-digit'
        });
        drawCanvas(item.ctx, item.country, t);
        item.tex.needsUpdate = true;
      } catch (e) {}
    });
  }
  setInterval(updateSprites, 1000);
  updateSprites();

  window.addEventListener('resize', () => {
    renderer.setSize(container.clientWidth, container.clientHeight);
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
  });

  const pauseBtn = document.getElementById('pauseBtn');
  if (pauseBtn) {
    pauseBtn.onclick = function () {
      controls.autoRotate = !controls.autoRotate;
      this.innerText = controls.autoRotate ? '‚è∏ Pause' : '‚ñ∂ Start Rotation';
    };
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();
})();

// Book init
(function initBook() {
  const container = document.getElementById('bookContainer');
  if (!container) return;
  if (container.clientWidth === 0) {
    setTimeout(initBook, 100);
    return;
  }

  const scene = new THREE.Scene();
  const aspect = container.clientWidth / container.clientHeight;
  const camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
  camera.position.set(0, 0, window.innerWidth < 768 ? 9 : 7);

  const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff, 0.7));
  const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
  dirLight.position.set(5, 10, 7);
  scene.add(dirLight);

  const geometry = new THREE.BoxGeometry(3.2, 4.6, 0.5);
  const materials = [
    new THREE.MeshLambertMaterial({ color: 0xfdfdfd }),
    new THREE.MeshLambertMaterial({ color: 0x111111 }),
    new THREE.MeshLambertMaterial({ color: 0xfdfdfd }),
    new THREE.MeshLambertMaterial({ color: 0xfdfdfd }),
    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('bookfront.jpg'), color: 0xffffff }),
    new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('bookcoverback.jpg'), color: 0xffffff })
  ];
  const book = new THREE.Mesh(geometry, materials);
  scene.add(book);
  book.rotation.x = 0.15;

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 2.0;

  const clock = new THREE.Clock();
  function animate() {
    requestAnimationFrame(animate);
    book.position.y = Math.sin(clock.getElapsedTime() * 1.5) * 0.1;
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    renderer.setSize(container.clientWidth, container.clientHeight);
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    camera.position.z = window.innerWidth < 768 ? 9 : 7;
  });
})();
</script>






</body>
</html>
